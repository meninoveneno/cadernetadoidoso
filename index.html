<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#4D6057">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="manifest" href="/manifest.json">
  <title>Caderneta Virtual do Idoso</title>
  <link rel="icon" type="image/png" href="https://i.imgur.com/BzIGz3X.png">
  <link rel="apple-touch-icon" href="https://i.imgur.com/BzIGz3X.png">
  <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-firestore-compat.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 16px;
      margin: 0;
      padding: 0;
      background-color: #f8f9fa;
      color: #333;
    }
    .container {
      max-width: 900px;
      margin: 20px auto;
      background: #fff;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 30px;
      border-radius: 12px;
      position: relative;
    }
    #homeScreen {
      text-align: center;
      padding: 50px 20px;
      background: linear-gradient(135deg, #4D6057, #839c90);
      color: #fff;
      border-radius: 12px;
      position: relative;
    }
    #homeScreen h1 {
      font-size: 36px;
      margin-bottom: 10px;
      font-weight: 600;
    }
    #homeScreen h2 {
      font-size: 20px;
      margin-bottom: 10px;
      font-weight: 400;
    }
    #homeScreen h3 {
      font-size: 18px;
      margin-bottom: 30px;
      font-weight: 400;
      font-style: italic;
    }
    #homeScreen img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      position: absolute;
      left: 20px;
      bottom: 20px;
      border: 3px solid #fff;
    }
    #homeScreen button {
      padding: 12px 20px;
      border: none;
      background: #3b5448;
      color: #fff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: background-color 0.3s;
      width: 100%;
      max-width: 200px;
    }
    #homeScreen button:hover {
      background-color: #2d4036;
    }
    #readQrBtn {
      margin-top: 10px;
      background-color: #839c90;
    }
    #readQrBtn:hover {
      background-color: #6d8a7d;
    }
    .tabs {
      display: flex;
      overflow-x: auto;
      padding: 0;
      list-style: none;
      border-bottom: 2px solid #e9ecef;
      margin-bottom: 20px;
    }
    .tabs li {
      text-align: center;
      padding: 12px 20px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      background-color: #e9ecef;
      border-radius: 8px 8px 0 0;
      transition: all 0.3s ease;
      flex-shrink: 0;
      min-width: 120px;
      margin-right: 8px;
      color: #495057;
    }
    .tabs li.active {
      background-color: #839c90;
      color: white;
      box-shadow: 0 4px 6px rgba(131, 156, 144, 0.2);
    }
    .tabs li:hover {
      background-color: #6d8a7d;
      color: white;
    }
    .tab-content {
      display: none;
      animation: fadeIn 0.5s ease-in-out;
    }
    .tab-content.active {
      display: block;
    }
    form label {
      display: block;
      margin-top: 12px;
      font-size: 16px;
      font-weight: 600;
      color: #495057;
    }
    form input,
    form select,
    form textarea {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      border: 1px solid #ced4da;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }
    form input:focus,
    form select:focus,
    form textarea:focus {
      border-color: #4D6057;
      outline: none;
      box-shadow: 0 0 0 3px rgba(77, 96, 87, 0.1);
    }
    form textarea {
      resize: vertical;
      min-height: 100px;
    }
    .btn {
      margin-top: 20px;
      padding: 12px 20px;
      border: none;
      background: #3b5448;
      color: #fff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: background-color 0.3s;
      width: 100%;
      max-width: 200px;
    }
    .btn:hover {
      background-color: #2d4036;
    }
    #addMedicamento,
    #addVacina {
      background: #4D6057;
      width: 100%;
      max-width: 200px;
    }
    #addMedicamento:hover,
    #addVacina:hover {
      background: #3b5448;
    }
    #monitoramentoBtn {
      background-color: #ffc107;
      color: #333;
    }
    #monitoramentoBtn:hover {
      background-color: #e0a800;
    }
    .popup {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #3b5448;
      color: #fff;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 16px;
      opacity: 0;
      transition: opacity 0.5s;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .popup.show {
      opacity: 1;
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    @media (max-width: 600px) {
      .tabs li {
        font-size: 14px;
        padding: 10px 15px;
        min-width: 100px;
      }
      button,
      form input,
      form select,
      form textarea {
        font-size: 14px;
        padding: 8px;
      }
      form label {
        font-size: 14px;
      }
      .review-buttons {
        flex-direction: column;
        gap: 10px;
      }
      .review-buttons .btn {
        max-width: 100%;
        width: 100%;
      }
      #homeScreen img {
        position: relative;
        left: auto;
        bottom: auto;
        margin: 20px auto;
        display: block;
      }
    }
    .review-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }
    #monitoramentoOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      z-index: 900;
    }
    #monitoramentoScreen {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      z-index: 1000;
      display: none;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    #monitoramentoScreen h3 {
      margin-top: 0;
      color: #333;
    }
    #monitoramentoScreen button {
      margin-top: 10px;
      width: 48%;
    }
    .vacina-form,
    .medicamento-form {
      border: 1px solid #e9ecef;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
      background-color: #f8f9fa;
    }
    .vacina-form .form-row,
    .medicamento-form .form-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    .vacina-form .form-row label,
    .medicamento-form .form-row label {
      flex: 1;
    }
    .vacina-form .form-row input,
    .vacina-form .form-row textarea,
    .medicamento-form .form-row input,
    .medicamento-form .form-row textarea {
      flex: 2;
    }
    .delete-btn {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 10px;
      transition: background-color 0.3s;
    }
    .delete-btn:hover {
      background-color: #c82333;
    }
    .review-container {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    .review-container h3 {
      margin-top: 0;
      color: #4D6057;
    }
    .alarm-btn {
      background-color: #ffc107;
      color: #333;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .alarm-btn:hover {
      background-color: #e0a800;
    }
    .alarm-btn i {
      font-size: 18px;
    }
    #medicalLoginScreen,
    #medicalAccessScreen,
    #userDetailScreen,
    #qrCodeScreen {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 12px;
      width: 95%;
      max-width: 800px;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    #userDetailTabs {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 5px;
      margin-bottom: 20px;
    }
    .detail-tab {
      padding: 12px;
      text-align: center;
      background: #e9ecef;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
    }
    .detail-tab.active {
      background: #839c90;
      color: white;
    }
    .detail-tab-content {
      display: none;
      padding: 15px;
      border: 1px solid #eee;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    .detail-tab-content.active {
      display: block;
    }
    .compact-form {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }
    .scrollable-detail {
      max-height: 60vh;
      overflow-y: auto;
      padding-right: 10px;
    }
    .detail-tab-content#detail-monitoramento {
      background-color: #fff9c4;
      padding: 15px;
      border-radius: 8px;
    }
    .monitoramento-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin: 5px 0;
      background-color: white;
      border-radius: 8px;
    }
    .delete-monitoramento-btn {
      background: #ff4444;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
    }
    #qrCodeScreen input {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    #qrCodeScreen label {
      display: block;
      margin-top: 12px;
      font-size: 16px;
      font-weight: 600;
      color: #495057;
    }
    #qrCodeContainer {
      text-align: center;
      margin: 20px 0;
      display: none;
    }
    @media (max-width: 600px) {
      #userDetailTabs {
        grid-template-columns: 1fr;
      }
      .detail-tab {
        font-size: 13px;
        padding: 10px;
      }
      .compact-form {
        grid-template-columns: 1fr;
      }
    }
    .medical-search {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .user-list {
      max-height: 400px;
      overflow-y: auto;
      margin: 15px 0;
    }
    .user-item {
      padding: 12px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background 0.2s;
    }
    .user-item:hover {
      background-color: #f8f9fa;
    }
    .medical-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }
    .editable-field {
      border: 1px solid transparent;
      padding: 5px;
      margin: 5px 0;
      transition: all 0.3s;
    }
    .editing .editable-field {
      border-color: #4D6057;
      background-color: #f8f9fa;
    }
    .edit-input {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .btn-danger {
      background-color: #dc3545;
    }
    .btn-danger:hover {
      background-color: #c82333;
    }
    .add-item-btn {
      margin: 10px 0;
      background: #4D6057;
    }
    .code-input {
      position: absolute;
      right: 20px;
      bottom: 20px;
      width: 100px;
    }
    #qrScannerModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }
    #qrScannerVideo {
      width: 90%;
      max-width: 500px;
      border-radius: 8px;
    }
    #closeScannerBtn {
      margin-top: 20px;
      background: #dc3545;
    }
    #scannerLoading {
      color: white;
      margin-bottom: 20px;
    }
    #scannerError {
      color: #ff6b6b;
      margin-bottom: 20px;
      display: none;
    }
  </style>
</head>
<body>
  <!-- Tela Inicial -->
  <div id="homeScreen" class="container">
    <h1>Caderneta Virtual do Idoso</h1>
    <h2>Cuidar hoje para viver melhor amanhã!</h2>
    <h3>Dra. Camilla Ribeiro | CRM: 57634 RQE: 42473</h3>
    <img src="https://i.imgur.com/BzIGz3X.png" alt="Logo">
    <button id="startBtn">Iniciar</button>
    <button id="readQrBtn">Ler QR Code</button>
  </div>

  <!-- Tela de Edição -->
  <div id="editScreen" class="container" style="display: none;">
    <ul class="tabs">
      <li class="tab active" data-tab="identificacao">Identificação</li>
      <li class="tab" data-tab="vacinacao">Vacinação</li>
      <li class="tab" data-tab="doencas">Doenças Crônicas</li>
      <li class="tab" data-tab="medicamentos">Medicamentos</li>
      <li class="tab" data-tab="recomendacoes">Anotações</li>
    </ul>

    <div class="tab-content active" id="identificacao">
      <form id="form-identificacao">
        <label for="nome">Nome:</label>
        <input type="text" id="nome" name="nome">
        <label for="dataNascimento">Data de Nascimento:</label>
        <input type="date" id="dataNascimento" name="dataNascimento">
        <label for="peso">Peso (kg):</label>
        <input type="number" id="peso" name="peso">
        <label for="contato">Contato:</label>
        <input type="tel" id="contato" name="contato">
        <label for="contatoEmergencia">Contato de Emergência:</label>
        <input type="tel" id="contatoEmergencia" name="contatoEmergencia">
      </form>
    </div>

    <div class="tab-content" id="vacinacao">
      <div id="vacinasContainer">
        <div class="vacina-form">
          <div class="form-row">
            <label for="nomeVacina">Nome da Vacina:</label>
            <input type="text" class="nomeVacina" name="nomeVacina[]">
          </div>
          <div class="form-row">
            <label for="dataAplicacao">Data de Aplicação:</label>
            <input type="date" class="dataAplicacao" name="dataAplicacao[]">
          </div>
          <div class="form-row">
            <label for="loteVacina">Lote:</label>
            <input type="text" class="loteVacina" name="loteVacina[]">
          </div>
          <div class="form-row">
            <label for="observacoesVacina">Observações:</label>
            <textarea class="observacoesVacina" name="observacoesVacina[]"></textarea>
          </div>
          <button type="button" class="delete-btn" onclick="deleteVacinaForm(this)">Excluir Vacina</button>
        </div>
      </div>
      <button type="button" id="addVacina" class="btn">Adicionar Vacina</button>
    </div>

    <div class="tab-content" id="doencas">
      <form id="form-doencas">
        <label><input type="checkbox" id="hipertensao" name="hipertensao"> Hipertensão</label>
        <label><input type="checkbox" id="diabetes" name="diabetes"> Diabetes</label>
        <label><input type="checkbox" id="cardiopatias" name="cardiopatias"> Cardiopatias</label>
        <label><input type="checkbox" id="chagas" name="chagas"> Chagas</label>
        <label for="outrasDoencas">Outras Doenças/Alergias:</label>
        <input type="text" id="outrasDoencas" name="outrasDoencas">
      </form>
    </div>

    <div class="tab-content" id="medicamentos">
      <form id="form-medicamentos">
        <div id="medicamentosContainer">
          <div class="medicamento-form">
            <label>Nome do Medicamento:</label>
            <input type="text" name="nomeMedicamento[]">
            <label>Dose:</label>
            <input type="text" name="doseMedicamento[]">
            <label>Posologia:</label>
            <input type="text" name="posologiaMedicamento[]">
            <label>Horário:</label>
            <input type="time" name="horarioMedicamento[]">
            <button type="button" class="delete-btn" onclick="deleteMedicamentoForm(this)">Excluir Medicamento</button>
          </div>
        </div>
        <button type="button" id="addMedicamento" class="btn">Adicionar Medicamento</button>
      </form>
    </div>

    <div class="tab-content" id="recomendacoes">
      <form id="form-recomendacoes">
        <label for="anotacoes">Anotações Médicas:</label>
        <textarea id="anotacoes" name="anotacoes"></textarea>
      </form>
    </div>

    <button id="saveBtn" class="btn">Salvar Dados</button>
    <div id="popup" class="popup">Dados salvos com sucesso!</div>
  </div>

  <!-- Tela de Revisão -->
  <div id="reviewScreen" class="container" style="display: none;">
    <h2>Dados do Idoso</h2>
    <div class="review-container">
      <h3>Identificação</h3>
      <div id="reviewIdentificacao"></div>
    </div>
    <div class="review-container">
      <h3>Vacinação</h3>
      <div id="reviewVacinacao"></div>
    </div>
    <div class="review-container">
      <h3>Doenças Crônicas e Alergias</h3>
      <div id="reviewDoencas"></div>
    </div>
    <div class="review-container">
      <h3>Medicamentos em Uso</h3>
      <div id="reviewMedicamentos"></div>
      <button class="alarm-btn" onclick="setMedicationAlarm()">
        <i class="fas fa-clock"></i>
        Definir alarme para medicações
      </button>
    </div>
    <div class="review-container">
      <h3>Mapeamento de PA e Glicemia</h3>
      <div id="reviewMonitoramento"></div>
    </div>
    <div class="review-container">
      <h3>Recomendações/Anotações Médicas</h3>
      <div id="reviewAnotacoes"></div>
    </div>
    <div class="review-buttons">
      <button id="exportBtn" class="btn">Exportar</button>
      <button id="monitoramentoBtn" class="btn">Monitoramento</button>
      <button id="medicalAccessBtn" class="btn">Acesso Médico</button>
      <button id="editBtn" class="btn">Editar</button>
      <button id="deleteAllBtn" class="btn">Excluir todos os dados</button>
    </div>
  </div>

  <!-- Tela de Login Médico -->
  <div id="medicalLoginScreen">
    <h2>Acesso Médico</h2>
    <input type="text" id="medUsername" placeholder="Usuário" class="medical-search">
    <input type="password" id="medPassword" placeholder="Senha" class="medical-search">
    <div class="medical-buttons">
      <button id="medLoginBtn" class="btn">Entrar</button>
      <button id="medBackBtn" class="btn">Voltar</button>
    </div>
  </div>

  <!-- Tela de Acesso Médico -->
  <div id="medicalAccessScreen">
    <h2>Acesso Médico</h2>
    <input type="text" id="userSearch" placeholder="Pesquisar usuários..." class="medical-search">
    <div class="user-list" id="userList"></div>
    <div class="medical-buttons">
      <button id="generateQrBtn" class="btn">Gerar QR CODE</button>
      <button id="medLogoutBtn" class="btn">Sair</button>
    </div>
  </div>

  <!-- Tela de Geração de QR Code -->
  <div id="qrCodeScreen">
    <h2>Gerar Novo Registro</h2>
    <form id="qrCodeForm">
      <label for="qrNome">Nome do Paciente:</label>
      <input type="text" id="qrNome" required>
      
      <label for="qrNascimento">Data de Nascimento:</label>
      <input type="date" id="qrNascimento" required>
      
      <div id="qrCodeContainer">
        <canvas id="qrCanvas"></canvas>
        <p style="margin-top: 10px;">Escaneie este QR code para cadastrar automaticamente</p>
      </div>
      
      <div class="medical-buttons">
        <button type="button" id="generateQrCodeBtn" class="btn">Gerar QR</button>
        <button type="button" id="closeQrBtn" class="btn">Fechar</button>
      </div>
    </form>
  </div>

  <!-- Tela de Detalhes do Paciente -->
  <div id="userDetailScreen">
    <h2>Detalhes do Paciente</h2>
    <div id="userDetailTabs">
      <div class="detail-tab active" data-tab="detail-identificacao">Identificação</div>
      <div class="detail-tab" data-tab="detail-vacinacao">Vacinação</div>
      <div class="detail-tab" data-tab="detail-doencas">Doenças</div>
      <div class="detail-tab" data-tab="detail-medicamentos">Medicamentos</div>
      <div class="detail-tab" data-tab="detail-anotacoes">Anotações</div>
      <div class="detail-tab" data-tab="detail-monitoramento">Monitoramento</div>
    </div>
    
    <div class="scrollable-detail">
      <div id="userDetailContent"></div>
    </div>

    <div class="medical-buttons">
      <button id="editUserBtn" class="btn" onclick="toggleEditMode()">Editar</button>
      <button id="saveUserBtn" class="btn" style="display: none;" onclick="saveUserChanges()">Salvar</button>
      <button class="btn btn-danger" onclick="deleteUser()">Excluir Usuário</button>
      <button onclick="closeUserDetail()" class="btn">Voltar</button>
    </div>
  </div>

  <!-- Overlay e Tela de Monitoramento -->
  <div id="monitoramentoOverlay"></div>
  <div id="monitoramentoScreen">
    <h3>Mapeamento de PA e Glicemia</h3>
    <form id="form-monitoramento">
      <label for="paMonitor">Pressão Arterial (PA):</label>
      <input type="text" id="paMonitor" name="paMonitor" placeholder="ex: 120/80">
      <label for="glicemiaMonitor">Glicemia:</label>
      <input type="number" id="glicemiaMonitor" name="glicemiaMonitor">
      <div style="display: flex; justify-content: space-between;">
        <button type="button" id="saveMonitorBtn" class="btn">Salvar Monitoramento</button>
        <button type="button" id="closeMonitorBtn" class="btn">Fechar</button>
      </div>
    </form>
  </div>

  <!-- Modal para Scanner de QR Code -->
  <div id="qrScannerModal">
    <div id="scannerLoading">Carregando scanner...</div>
    <div id="scannerError" style="display: none;"></div>
    <video id="qrScannerVideo" playsinline></video>
    <button id="closeScannerBtn" class="btn">Fechar Scanner</button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCMP_bBotEMngO0pLkxhrZvvgCJqIFTZCY",
      authDomain: "cadernetavirtualdoidoso.firebaseapp.com",
      projectId: "cadernetavirtualdoidoso",
      storageBucket: "cadernetavirtualdoidoso.appspot.com",
      messagingSenderId: "374078415962",
      appId: "1:374078415962:web:8d8566388ee8336f986463"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let currentDetailTab = 'detail-identificacao';
    let reviewUnsubscribe = null;
    let userDetailUnsubscribe = null;
    let currentEditingUser = null;
    let isEditing = false;
    let currentUserData = null;

    function generateUsername(nome, dataNascimento) {
      const normalized = nome.toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
        .replace(/\s+/g, '')
        .replace(/[^a-z0-9]/g, '');
      const cleanDate = dataNascimento.replace(/-/g, '');
      return normalized + cleanDate;
    }

    function setupRealtimeUpdates(username) {
      if(reviewUnsubscribe) reviewUnsubscribe();
      return db.collection('usuarios').doc(username).onSnapshot(doc => {
        if(doc.exists) updateReviewScreen(doc.data());
      }, error => {
        console.error('Erro na escuta em tempo real:', error);
      });
    }

    // [MANTIDAS TODAS AS FUNÇÕES EXISTENTES ANTERIORES]

    // NOVA IMPLEMENTAÇÃO DO QR SCANNER
    function startQRScanner() {
      const modal = document.getElementById('qrScannerModal');
      const video = document.getElementById('qrScannerVideo');
      const loading = document.getElementById('scannerLoading');
      const errorDisplay = document.getElementById('scannerError');
      
      modal.style.display = 'flex';
      loading.style.display = 'block';
      errorDisplay.style.display = 'none';
      loading.textContent = 'Iniciando câmera...';
      
      let stream = null;
      let canvas = document.createElement('canvas');
      let ctx = canvas.getContext('2d');
      let animationFrame = null;
      
      // Tenta usar API nativa primeiro
      if (!('BarcodeDetector' in window)) {
        loading.textContent = 'Usando modo compatível...';
      }

      navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(s => {
          stream = s;
          video.srcObject = s;
          video.play();
          loading.textContent = 'Aponte para o QR Code...';
          
          video.onplaying = () => {
            loading.style.display = 'none';
            scanFrame();
          };
          
          function scanFrame() {
            if (!video.videoWidth) {
              animationFrame = requestAnimationFrame(scanFrame);
              return;
            }
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            try {
              let detectionPromise;
              
              if (window.BarcodeDetector) {
                const barcodeDetector = new BarcodeDetector({ formats: ['qr_code'] });
                detectionPromise = barcodeDetector.detect(canvas);
              } else {
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                detectionPromise = Promise.resolve(code ? [{ rawValue: code.data }] : []);
              }
              
              detectionPromise.then(barcodes => {
                if (barcodes.length > 0) {
                  const qrData = barcodes[0].rawValue;
                  try {
                    const data = JSON.parse(qrData);
                    fillFormFromQR(data);
                    stopScanner();
                  } catch (e) {
                    showScannerError('QR Code inválido');
                  }
                }
                animationFrame = requestAnimationFrame(scanFrame);
              }).catch(err => {
                console.error('Erro na detecção:', err);
                animationFrame = requestAnimationFrame(scanFrame);
              });
            } catch (err) {
              console.error('Erro no scanner:', err);
              animationFrame = requestAnimationFrame(scanFrame);
            }
          }
        })
        .catch(err => {
          console.error('Erro ao acessar câmera:', err);
          showScannerError('Não foi possível acessar a câmera. Verifique as permissões.');
        });
      
      document.getElementById('closeScannerBtn').addEventListener('click', stopScanner);
      
      function stopScanner() {
        if (animationFrame) {
          cancelAnimationFrame(animationFrame);
        }
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
        }
        modal.style.display = 'none';
      }
      
      function showScannerError(message) {
        errorDisplay.textContent = message;
        errorDisplay.style.display = 'block';
        loading.style.display = 'none';
      }
    }

    function fillFormFromQR(data) {
      if (data.nome) document.getElementById('nome').value = data.nome;
      if (data.dataNascimento) document.getElementById('dataNascimento').value = data.dataNascimento;
      if (data.peso) document.getElementById('peso').value = data.peso;
      if (data.contato) document.getElementById('contato').value = data.contato;
      if (data.contatoEmergencia) document.getElementById('contatoEmergencia').value = data.contatoEmergencia;
      
      document.getElementById('homeScreen').style.display = 'none';
      document.getElementById('editScreen').style.display = 'block';
      showPopup('Dados do paciente carregados do QR Code!');
    }

    // [MANTIDO O RESTO DO CÓDIGO ORIGINAL]
    document.getElementById('readQrBtn').addEventListener('click', startQRScanner);

    // [TODAS AS OUTRAS FUNÇÕES ORIGINAIS MANTIDAS]
    document.getElementById('startBtn').addEventListener('click', () => {
      document.getElementById('homeScreen').style.display = 'none';
      document.getElementById('editScreen').style.display = 'block';
      if (document.documentElement.requestFullscreen) {
        document.documentElement.requestFullscreen();
      }
    });

    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.getAttribute('data-tab')).classList.add('active');
      });
    });

    // [CONTINUAÇÃO DE TODAS AS FUNÇÕES ORIGINAIS...]

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => {
            console.log('Service Worker registrado:', registration.scope);
          })
          .catch(error => {
            console.log('Falha no registro:', error);
          });
      });
    }
  </script>
</body>
</html>
