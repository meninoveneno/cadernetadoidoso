<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#4D6057">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="manifest" href="/manifest.json">
  <title>Caderneta Idoso</title>
  <link rel="icon" type="image/png" href="https://i.imgur.com/BzIGz3X.png">
  <link rel="apple-touch-icon" href="https://i.imgur.com/BzIGz3X.png">
  <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-storage-compat.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <style>
    .contact-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background-color: #4D6057;
      color: white;
      padding: 10px 15px;
      font-size: 14px;
      z-index: 1000;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .contact-header a {
      color: white;
      text-decoration: none;
      transition: opacity 0.2s;
      white-space: nowrap;
    }
    
    .contact-header a:hover {
      opacity: 0.8;
      text-decoration: underline;
    }

    .contact-separator {
      display: inline-block;
    }

    @media (max-width: 600px) {
      .contact-header {
        font-size: 12px;
        padding: 8px 5px;
        gap: 8px;
        flex-direction: row;
        justify-content: center;
        flex-wrap: wrap;
      }
      
      .contact-separator {
        display: inline-block;
      }
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 16px;
      margin: 0;
      padding-top: 50px;
      background-color: #f8f9fa;
      color: #333;
    }
    .container {
      max-width: 900px;
      margin: 20px auto;
      background: #fff;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 30px;
      border-radius: 12px;
      position: relative;
    }
    #homeScreen {
      text-align: center;
      padding: 50px 20px;
      background: linear-gradient(135deg, #4D6057, #839c90);
      color: #fff;
      border-radius: 12px;
      position: relative;
    }
    #homeScreen h1 {
      font-size: 36px;
      margin-bottom: 10px;
      font-weight: 600;
    }
    #homeScreen h2 {
      font-size: 20px;
      margin-bottom: 10px;
      font-weight: 400;
    }
    #homeScreen h3 {
      font-size: 18px;
      margin-bottom: 30px;
      font-weight: 400;
      font-style: italic;
    }
    #homeScreen img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      position: absolute;
      left: 20px;
      bottom: 20px;
      border: 3px solid #fff;
    }
    #homeScreen button {
      padding: 12px 20px;
      border: none;
      background: #3b5448;
      color: #fff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: background-color 0.3s;
      width: 100%;
      max-width: 200px;
    }
    #homeScreen button:hover {
      background-color: #2d4036;
    }
    #readQrBtn {
      margin-top: 10px;
      background-color: #839c90;
    }
    #readQrBtn:hover {
      background-color: #6d8a7d;
    }
    .tabs {
      display: flex;
      overflow-x: auto;
      padding: 0;
      list-style: none;
      border-bottom: 2px solid #e9ecef;
      margin-bottom: 20px;
    }
    .tabs li {
      text-align: center;
      padding: 12px 20px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      background-color: #e9ecef;
      border-radius: 8px 8px 0 0;
      transition: all 0.3s ease;
      flex-shrink: 0;
      min-width: 120px;
      margin-right: 8px;
      color: #495057;
    }
    .tabs li.active {
      background-color: #839c90;
      color: white;
      box-shadow: 0 4px 6px rgba(131, 156, 144, 0.2);
    }
    .tabs li:hover {
      background-color: #6d8a7d;
      color: white;
    }
    .tab-content {
      display: none;
      animation: fadeIn 0.5s ease-in-out;
    }
    .tab-content.active {
      display: block;
    }
    form label {
      display: block;
      margin-top: 12px;
      font-size: 16px;
      font-weight: 600;
      color: #495057;
    }
    form input,
    form select,
    form textarea {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      border: 1px solid #ced4da;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }
    form input:focus,
    form select:focus,
    form textarea:focus {
      border-color: #4D6057;
      outline: none;
      box-shadow: 0 0 0 3px rgba(77, 96, 87, 0.1);
    }
    form textarea {
      resize: vertical;
      min-height: 100px;
    }
    .btn {
      margin-top: 20px;
      padding: 12px 20px;
      border: none;
      background: #3b5448;
      color: #fff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: background-color 0.3s;
      width: 100%;
      max-width: 200px;
    }
    .btn:hover {
      background-color: #2d4036;
    }
    #addMedicamento,
    #addVacina {
      background: #4D6057;
      width: 100%;
      max-width: 200px;
    }
    #addMedicamento:hover,
    #addVacina:hover {
      background: #3b5448;
    }
    #monitoramentoBtn {
      background-color: #ffc107;
      color: #333;
    }
    #monitoramentoBtn:hover {
      background-color: #e0a800;
    }
    .popup {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #3b5448;
      color: #fff;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 16px;
      opacity: 0;
      transition: opacity 0.5s;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .popup.show {
      opacity: 1;
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    @media (max-width: 600px) {
      .tabs li {
        font-size: 14px;
        padding: 10px 15px;
        min-width: 100px;
      }
      button,
      form input,
      form select,
      form textarea {
        font-size: 14px;
        padding: 8px;
      }
      form label {
        font-size: 14px;
      }
      .review-buttons {
        flex-direction: column;
        gap: 10px;
      }
      .review-buttons .btn {
        max-width: 100%;
        width: 100%;
      }
      #homeScreen img {
        position: relative;
        left: auto;
        bottom: auto;
        margin: 20px auto;
        display: block;
      }
      body {
        padding-top: 80px;
      }
    }
    .review-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }
    #monitoramentoOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      z-index: 900;
    }
    #monitoramentoScreen {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      z-index: 1000;
      display: none;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    #monitoramentoScreen h3 {
      margin-top: 0;
      color: #333;
    }
    #monitoramentoScreen button {
      margin-top: 10px;
      width: 48%;
    }
    .vacina-form,
    .medicamento-form {
      border: 1px solid #e9ecef;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
      background-color: #f8f9fa;
    }
    .vacina-form .form-row,
    .medicamento-form .form-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    .vacina-form .form-row label,
    .medicamento-form .form-row label {
      flex: 1;
    }
    .vacina-form .form-row input,
    .vacina-form .form-row textarea,
    .medicamento-form .form-row input,
    .medicamento-form .form-row textarea {
      flex: 2;
    }
    .delete-btn {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 10px;
      transition: background-color 0.3s;
    }
    .delete-btn:hover {
      background-color: #c82333;
    }
    .review-container {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      position: relative;
    }
    .review-container h3 {
      margin-top: 0;
      color: #4D6057;
    }
    .alarm-btn {
      background-color: #4D6057;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 15px;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s;
      width: 100%;
      max-width: 300px;
      margin: 15px auto;
      border: none;
      font-size: 16px;
      font-weight: 600;
    }
    .alarm-btn:hover {
      background-color: #3b5448;
    }
    .alarm-btn i {
      font-size: 18px;
    }
    #medicalLoginScreen,
    #medicalAccessScreen,
    #userDetailScreen,
    #qrCodeScreen {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 12px;
      width: 95%;
      max-width: 800px;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      text-align: left;
    }
    #userDetailTabs {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 5px;
      margin-bottom: 20px;
    }
    .detail-tab {
      padding: 12px;
      text-align: center;
      background: #e9ecef;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
    }
    .detail-tab.active {
      background: #839c90;
      color: white;
    }
    .detail-tab-content {
      display: none;
      padding: 15px;
      border: 1px solid #eee;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: left;
      position: relative;
      z-index: 1;
    }
    .detail-tab-content.active {
      display: block;
      z-index: 2;
    }
    .compact-form {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      text-align: left;
    }
    .scrollable-detail {
      max-height: 60vh;
      overflow-y: auto;
      padding-right: 10px;
      text-align: left;
    }
    .detail-tab-content#detail-monitoramento {
      background-color: #fff9c4;
      padding: 15px;
      border-radius: 8px;
      text-align: left;
    }
    .monitoramento-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin: 5px 0;
      background-color: white;
      border-radius: 8px;
      text-align: left;
    }
    .delete-monitoramento-btn {
      background: #ff4444;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
    }
    #qrCodeScreen input {
      width: 80%;
      max-width: 400px;
      padding: 10px;
      margin: 10px auto;
      border: 1px solid #ddd;
      border-radius: 8px;
      display: block;
    }
    #qrCodeScreen label {
      display: block;
      margin-top: 12px;
      font-size: 16px;
      font-weight: 600;
      color: #495057;
      text-align: left;
    }
    #qrCodeContainer {
      text-align: center;
      margin: 20px 0;
      display: none;
    }
    .medical-search {
      width: 80%;
      max-width: 400px;
      padding: 10px;
      margin: 10px auto;
      border: 1px solid #ddd;
      border-radius: 8px;
      display: block;
    }
    .user-list {
      max-height: 400px;
      overflow-y: auto;
      margin: 15px auto;
      width: 90%;
      max-width: 600px;
      text-align: left;
    }
    .user-item {
      padding: 15px;
      margin: 10px 0;
      background: #f8f9fa;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: left;
    }
    .user-item:hover {
      background: #e9ecef;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .user-name {
      font-weight: 600;
      font-size: 1.1em;
      margin-bottom: 5px;
    }
    .user-details {
      display: flex;
      justify-content: space-between;
      font-size: 0.9em;
      color: #666;
    }
    .medical-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }
    .editable-field {
      border: 1px solid transparent;
      padding: 5px;
      margin: 5px 0;
      transition: all 0.3s;
      text-align: left;
    }
    .editing .editable-field {
      border-color: #4D6057;
      background-color: #f8f9fa;
    }
    .edit-input {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      text-align: left;
    }
    .btn-danger {
      background-color: #dc3545;
    }
    .btn-danger:hover {
      background-color: #c82333;
    }
    .add-item-btn {
      margin: 10px 0;
      background: #4D6057;
    }
    .code-input {
      position: absolute;
      right: 20px;
      bottom: 20px;
      width: 100px;
    }
    #qrScannerModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }
    #qrScannerVideo {
      width: 90%;
      max-width: 500px;
      border-radius: 8px;
    }
    #closeScannerBtn {
      margin-top: 20px;
      background: #dc3545;
    }
    .no-users {
      text-align: center;
      color: #666;
      padding: 20px;
    }
    .exames-container {
      margin-top: 20px;
      border: 1px solid #e9ecef;
      padding: 20px;
      border-radius: 8px;
      background-color: #f8f9fa;
    }
    
    .exames-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      gap: 10px;
    }
    
    .exames-title {
      font-size: 18px;
      font-weight: bold;
      color: #4D6057;
      margin: 0;
    }
    
    .exames-actions {
      display: flex;
      gap: 10px;
    }
    
    .exame-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      margin: 10px 0;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    
    .exame-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .exame-info {
      display: flex;
      align-items: center;
      gap: 15px;
      flex: 1;
    }
    
    .exame-thumbnail {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 4px;
      border: 1px solid #ddd;
      cursor: pointer;
    }
    
    .exame-details {
      flex: 1;
    }
    
    .exame-name {
      font-weight: 500;
      margin-bottom: 5px;
    }
    
    .exame-date {
      font-size: 12px;
      color: #666;
    }
    
    .exame-actions {
      display: flex;
      gap: 8px;
    }
    
    .exame-action-btn {
      background: none;
      border: none;
      color: #4D6057;
      cursor: pointer;
      font-size: 16px;
      transition: color 0.2s;
    }
    
    .exame-action-btn:hover {
      color: #3b5448;
    }
    
    .exame-preview {
      max-width: 100%;
      max-height: 300px;
      margin: 10px 0;
      display: none;
      border-radius: 4px;
    }
    
    #examePreviewModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    #examePreviewImage {
      max-width: 90%;
      max-height: 90%;
      border-radius: 4px;
    }
    
    #closePreviewBtn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #dc3545;
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 18px;
    }
    .action-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
    }
    
    .action-btn {
      flex: 1;
      min-width: 120px;
      padding: 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .action-btn i {
      font-size: 16px;
    }
    
    .btn-primary {
      background-color: #4D6057;
      color: white;
    }
    
    .btn-primary:hover {
      background-color: #3b5448;
    }
    
    .btn-secondary {
      background-color: #839c90;
      color: white;
    }
    
    .btn-secondary:hover {
      background-color: #6d8a7d;
    }
    
    .btn-warning {
      background-color: #ffc107;
      color: #333;
    }
    
    .btn-warning:hover {
      background-color: #e0a800;
    }
    
    .btn-danger {
      background-color: #dc3545;
      color: white;
    }
    
    .btn-danger:hover {
      background-color: #c82333;
    }
    
    .exam-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 12px;
      z-index: 1000;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      display: none;
    }
    
    .exam-modal h3 {
      margin-top: 0;
      color: #4D6057;
      text-align: center;
    }
    
    .exam-modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .exam-modal-actions .action-btn {
      flex: 1;
    }
    
    /* Novos estilos para a câmera */
    .camera-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: black;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1001;
    }
    
    #cameraVideo {
      width: 100%;
      max-width: 500px;
      background: black;
    }
    
    .camera-controls {
      position: fixed;
      bottom: 20px;
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 20px;
      z-index: 1002;
    }
    
    .camera-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      background: rgba(255,255,255,0.2);
      color: white;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    #captureBtn {
      background: #fff;
      color: #333;
    }
    
    #closeCameraBtn {
      background: #dc3545;
    }
    
    #flipCameraBtn {
      background: rgba(255,255,255,0.2);
    }
    
    #cameraCanvas {
      display: none;
    }
    
    .exam-name-dialog {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      z-index: 1003;
      width: 90%;
      max-width: 400px;
      display: none;
    }
    
    .exam-name-dialog h3 {
      margin-top: 0;
      color: #4D6057;
    }
    
    .exam-name-dialog input {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .exam-name-dialog-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 15px;
    }
    
    /* Estilos para o modal de prévia da foto */
    #photoPreviewModal {
      z-index: 1002;
    }
    
    #photoPreviewModal img {
      max-height: 50vh;
      border-radius: 8px;
      border: 2px solid #fff;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    /* Estilo para a imagem na identificação */
    .identification-logo {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 40px;
      height: 40px;
      opacity: 0.7;
      transition: opacity 0.3s;
    }
    
    .identification-logo:hover {
      opacity: 1;
    }
    
    /* Estilos para o carrossel de fotos */
    .photo-carousel {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding: 10px 0;
      margin: 10px 0;
    }
    
    .photo-thumbnail {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 4px;
      border: 1px solid #ddd;
      cursor: pointer;
    }
    
    .photo-thumbnail.active {
      border: 2px solid #4D6057;
    }
    
    @media (max-width: 600px) {
      .exame-info {
        gap: 10px;
      }
      
      .exame-thumbnail {
        width: 50px;
        height: 50px;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .action-btn {
        width: 100%;
      }
      
      .identification-logo {
        width: 30px;
        height: 30px;
        top: 10px;
        right: 10px;
      }
    }
    #medicalLoginScreen h2,
    #medicalAccessScreen h2,
    #qrCodeScreen h2 {
      text-align: center;
      margin-bottom: 20px;
    }

    #qrCodeScreen form {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #qrCodeScreen label {
      text-align: center;
      width: 100%;
    }

    #qrCodeScreen input {
      text-align: center;
    }

    #medicalLoginScreen,
    #medicalAccessScreen,
    #qrCodeScreen {
      text-align: left;
    }

    @media (max-width: 600px) {
      #userDetailTabs {
        grid-template-columns: 1fr;
      }
      .detail-tab {
        font-size: 13px;
        padding: 10px;
      }
      .compact-form {
        grid-template-columns: 1fr;
      }
      .user-details {
        flex-direction: column;
      }
      .medical-search {
        width: 90%;
      }
    }
  </style>
</head>
<body>
  <!-- Cabeçalho de contato simplificado - Modificado para manter em linha em mobile -->
  <div class="contact-header">
    <a href="https://www.instagram.com/camillaribeirogeriatra" target="_blank" title="Acessar Instagram">
      <i class="fab fa-instagram"></i> @camillaribeirogeriatra
    </a>
    <span class="contact-separator">|</span>
    <a href="https://wa.me/5538999037071" title="Enviar mensagem no WhatsApp">
      <i class="fab fa-whatsapp"></i> (38) 99903-7071
    </a>
  </div>

  <!-- Tela Inicial -->
  <div id="homeScreen" class="container">
    <h1>Caderneta Virtual do Idoso</h1>
    <h2>Cuidar hoje para viver melhor amanhã!</h2>
    <h3>Dra. Camilla Ribeiro | CRM: 57634 RQE: 42473</h3>
    <img src="https://i.imgur.com/BzIGz3X.png" alt="Logo">
    <button id="startBtn">Iniciar</button>
    <button id="readQrBtn">Ler QR Code</button>
  </div>

  <!-- Tela de Edição -->
  <div id="editScreen" class="container" style="display: none;">
    <ul class="tabs">
      <li class="tab active" data-tab="identificacao">Identificação</li>
      <li class="tab" data-tab="vacinacao">Vacinação</li>
      <li class="tab" data-tab="doencas">Doenças Crônicas</li>
      <li class="tab" data-tab="medicamentos">Medicamentos</li>
      <li class="tab" data-tab="recomendacoes">Anotações</li>
    </ul>

    <div class="tab-content active" id="identificacao">
      <form id="form-identificacao">
        <label for="nome">Nome:</label>
        <input type="text" id="nome" name="nome">
        <label for="dataNascimento">Data de Nascimento:</label>
        <input type="date" id="dataNascimento" name="dataNascimento">
        <label for="peso">Peso (kg):</label>
        <input type="number" id="peso" name="peso">
        <label for="contato">Contato:</label>
        <input type="tel" id="contato" name="contato">
        <label for="contatoEmergencia">Contato de Emergência:</label>
        <input type="tel" id="contatoEmergencia" name="contatoEmergencia">
      </form>
    </div>

    <div class="tab-content" id="vacinacao">
      <div id="vacinasContainer">
        <div class="vacina-form">
          <div class="form-row">
            <label for="nomeVacina">Nome da Vacina:</label>
            <input type="text" class="nomeVacina" name="nomeVacina[]">
          </div>
          <div class="form-row">
            <label for="dataAplicacao">Data de Aplicação:</label>
            <input type="date" class="dataAplicacao" name="dataAplicacao[]">
          </div>
          <div class="form-row">
            <label for="loteVacina">Lote:</label>
            <input type="text" class="loteVacina" name="loteVacina[]">
          </div>
          <div class="form-row">
            <label for="observacoesVacina">Observações:</label>
            <textarea class="observacoesVacina" name="observacoesVacina[]"></textarea>
          </div>
          <button type="button" class="delete-btn" onclick="deleteVacinaForm(this)">Excluir Vacina</button>
        </div>
      </div>
      <button type="button" id="addVacina" class="btn">Adicionar Vacina</button>
    </div>

    <div class="tab-content" id="doencas">
      <form id="form-doencas">
        <label><input type="checkbox" id="hipertensao" name="hipertensao"> Hipertensão</label>
        <label><input type="checkbox" id="diabetes" name="diabetes"> Diabetes</label>
        <label><input type="checkbox" id="cardiopatias" name="cardiopatias"> Cardiopatias</label>
        <label><input type="checkbox" id="chagas" name="chagas"> Chagas</label>
        <label for="outrasDoencas">Outras Doenças/Alergias:</label>
        <input type="text" id="outrasDoencas" name="outrasDoencas">
      </form>
    </div>

    <div class="tab-content" id="medicamentos">
      <form id="form-medicamentos">
        <div id="medicamentosContainer">
          <div class="medicamento-form">
            <label>Nome do Medicamento:</label>
            <input type="text" name="nomeMedicamento[]">
            <label>Dose:</label>
            <input type="text" name="doseMedicamento[]">
            <label>Posologia:</label>
            <input type="text" name="posologiaMedicamento[]">
            <label>Horário:</label>
            <input type="time" name="horarioMedicamento[]">
            <button type="button" class="delete-btn" onclick="deleteMedicamentoForm(this)">Excluir Medicamento</button>
          </div>
        </div>
        <button type="button" id="addMedicamento" class="btn">Adicionar Medicamento</button>
      </form>
    </div>

    <div class="tab-content" id="recomendacoes">
      <form id="form-recomendacoes">
        <label for="anotacoes">Anotações Médicas:</label>
        <textarea id="anotacoes" name="anotacoes"></textarea>
      </form>
    </div>

    <button id="saveBtn" class="btn">Salvar Dados</button>
    <div id="popup" class="popup">Dados salvos com sucesso!</div>
  </div>

  <!-- Tela de Revisão -->
  <div id="reviewScreen" class="container" style="display: none;">
    <h2>Dados do Idoso</h2>
    <div class="review-container">
      <h3>Identificação</h3>
      <img src="https://i.imgur.com/XRYaCsH.png" alt="Logo" class="identification-logo">
      <div id="reviewIdentificacao"></div>
    </div>
    <div class="review-container">
      <h3>Vacinação</h3>
      <div id="reviewVacinacao"></div>
    </div>
    <div class="review-container">
      <h3>Doenças Crônicas e Alergias</h3>
      <div id="reviewDoencas"></div>
    </div>
    <div class="review-container">
      <h3>Medicamentos em Uso</h3>
      <div id="reviewMedicamentos"></div>
      <button class="alarm-btn" onclick="setMedicationAlarm()">
        <i class="fas fa-clock"></i>
        Definir alarme para medicações
      </button>
    </div>
    <div class="review-container">
      <h3>Mapeamento de PA e Glicemia</h3>
      <div id="reviewMonitoramento"></div>
    </div>
    <div class="review-container">
      <h3>Recomendações/Anotações Médicas</h3>
      <div id="reviewAnotacoes"></div>
    </div>
    
    <!-- Seção de Exames melhorada -->
    <div class="review-container">
      <h3>Exames</h3>
      <div class="exames-container">
        <div class="exames-header">
          <div class="exames-title">Documentos e Exames</div>
          <div class="exames-actions">
            <button id="addExamBtn" class="action-btn btn-primary">
              <i class="fas fa-plus"></i> Adicionar Exame
            </button>
          </div>
        </div>
        <div id="examesList"></div>
      </div>
    </div>
    
    <div class="review-buttons">
      <button id="exportBtn" class="btn">Exportar</button>
      <button id="monitoramentoBtn" class="btn">Monitoramento</button>
      <button id="medicalAccessBtn" class="btn">Acesso Médico</button>
      <button id="editBtn" class="btn">Editar</button>
      <button id="deleteAllBtn" class="btn btn-danger">
        <i class="fas fa-trash"></i> Excluir todos os dados
      </button>
    </div>
  </div>

  <!-- Tela de Login Médico -->
  <div id="medicalLoginScreen">
    <h2>Acesso Médico</h2>
    <input type="text" id="medUsername" placeholder="Usuário" class="medical-search">
    <input type="password" id="medPassword" placeholder="Senha" class="medical-search">
    <div class="medical-buttons">
      <button id="medLoginBtn" class="btn">Entrar</button>
      <button id="medBackBtn" class="btn">Voltar</button>
    </div>
  </div>

  <!-- Tela de Acesso Médico -->
  <div id="medicalAccessScreen">
    <h2>Acesso Médico</h2>
    <input type="text" id="userSearch" placeholder="Pesquisar usuários..." class="medical-search">
    <div class="user-list" id="userList"></div>
    <div class="medical-buttons">
      <button id="generateQrBtn" class="btn">Gerar QR CODE</button>
      <button id="medLogoutBtn" class="btn">Sair</button>
    </div>
  </div>

  <!-- Tela de Geração de QR Code -->
  <div id="qrCodeScreen">
    <h2>Gerar Novo Registro</h2>
    <form id="qrCodeForm">
      <label for="qrNome">Nome do Paciente:</label>
      <input type="text" id="qrNome" required>
      
      <label for="qrNascimento">Data de Nascimento:</label>
      <input type="date" id="qrNascimento" required>
      
      <div id="qrCodeContainer">
        <canvas id="qrCanvas"></canvas>
        <p style="margin-top: 10px;">Escaneie este QR code para cadastrar automaticamente</p>
      </div>
      
      <div class="medical-buttons">
        <button type="button" id="generateQrCodeBtn" class="btn">Gerar QR</button>
        <button type="button" id="closeQrBtn" class="btn">Fechar</button>
      </div>
    </form>
  </div>

  <!-- Tela de Detalhes do Paciente -->
  <div id="userDetailScreen">
    <h2>Detalhes do Paciente</h2>
    <div id="userDetailTabs">
      <div class="detail-tab active" data-tab="detail-identificacao">Identificação</div>
      <div class="detail-tab" data-tab="detail-vacinacao">Vacinação</div>
      <div class="detail-tab" data-tab="detail-doencas">Doenças</div>
      <div class="detail-tab" data-tab="detail-medicamentos">Medicamentos</div>
      <div class="detail-tab" data-tab="detail-anotacoes">Anotações</div>
      <div class="detail-tab" data-tab="detail-monitoramento">Monitoramento</div>
      <div class="detail-tab" data-tab="detail-exames">Exames</div>
    </div>
    
    <div class="scrollable-detail">
      <div id="userDetailContent"></div>
    </div>

    <div class="medical-buttons">
      <button id="editUserBtn" class="btn" onclick="toggleEditMode()">Editar</button>
      <button id="saveUserBtn" class="btn" style="display: none;" onclick="saveUserChanges()">Salvar</button>
      <button class="btn btn-danger" onclick="deleteUser()">Excluir Usuário</button>
      <button onclick="closeUserDetail()" class="btn">Voltar</button>
    </div>
  </div>

  <!-- Overlay e Tela de Monitoramento -->
  <div id="monitoramentoOverlay"></div>
  <div id="monitoramentoScreen">
    <h3>Mapeamento de PA e Glicemia</h3>
    <form id="form-monitoramento">
      <label for="paMonitor">Pressão Arterial (PA):</label>
      <input type="text" id="paMonitor" name="paMonitor" placeholder="ex: 120/80">
      <label for="glicemiaMonitor">Glicemia:</label>
      <input type="number" id="glicemiaMonitor" name="glicemiaMonitor">
      <div style="display: flex; justify-content: space-between;">
        <button type="button" id="saveMonitorBtn" class="btn">Salvar Monitoramento</button>
        <button type="button" id="closeMonitorBtn" class="btn">Fechar</button>
      </div>
    </form>
  </div>

  <!-- Modal para Scanner de QR Code -->
  <div id="qrScannerModal">
    <video id="qrScannerVideo" playsinline></video>
    <button id="closeScannerBtn" class="btn">Fechar Scanner</button>
  </div>
  
  <!-- Modal para visualização de exames -->
  <div id="examePreviewModal">
    <button id="closePreviewBtn"><i class="fas fa-times"></i></button>
    <img id="examePreviewImage" src="" alt="Visualização do Exame">
  </div>
  
  <!-- Modal para upload/tirar foto de exames -->
  <div id="examModal" class="exam-modal">
    <h3>Adicionar Exame</h3>
    <p>Escolha como deseja adicionar o exame:</p>
    <div class="exam-modal-actions">
      <button id="takePhotoBtn" class="action-btn btn-primary">
        <i class="fas fa-camera"></i> Tirar Foto
      </button>
      <button id="uploadPhotoBtn" class="action-btn btn-secondary">
        <i class="fas fa-upload"></i> Upload
      </button>
    </div>
    <button id="closeExamModalBtn" class="action-btn btn-danger" style="margin-top: 10px;">
      <i class="fas fa-times"></i> Cancelar
    </button>
  </div>

  <!-- Modal de Prévia da Foto -->
  <div id="photoPreviewModal" class="exam-modal" style="display: none;">
    <h3>Prévia do Exame</h3>
    <div class="photo-carousel" id="photoCarousel"></div>
    <img id="previewImage" src="" alt="Prévia do Exame" style="max-width: 100%; margin: 15px 0;">
    <div class="exam-modal-actions">
      <button id="retakePhotoBtn" class="action-btn btn-danger">
        <i class="fas fa-sync-alt"></i> Tirar Novamente
      </button>
      <button id="confirmPhotoBtn" class="action-btn btn-primary">
        <i class="fas fa-check"></i> Confirmar
      </button>
    </div>
  </div>

  <!-- Input oculto para upload de arquivos -->
  <input type="file" id="examFileInput" accept="image/*" multiple style="display: none;">

  <!-- Elementos da câmera para exames -->
  <div class="camera-container" id="cameraContainer">
    <video id="cameraVideo" autoplay playsinline></video>
    <canvas id="cameraCanvas"></canvas>
    
    <div class="camera-controls">
      <button id="closeCameraBtn" class="camera-btn">
        <i class="fas fa-times"></i>
      </button>
      <button id="captureBtn" class="camera-btn">
        <i class="fas fa-camera"></i>
      </button>
      <button id="flipCameraBtn" class="camera-btn">
        <i class="fas fa-sync-alt"></i>
      </button>
    </div>
  </div>
  
  <div class="exam-name-dialog" id="examNameDialog">
    <h3>Nome do Exame</h3>
    <input type="text" id="examNameInput" placeholder="Digite o nome do exame">
    <div class="exam-name-dialog-buttons">
      <button id="cancelExamNameBtn" class="btn btn-danger">Cancelar</button>
      <button id="saveExamNameBtn" class="btn">Salvar</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // Adicionando o prompt de instalação do PWA
    let deferredPrompt;
    
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      showInstallPrompt();
    });
    
    function showInstallPrompt() {
      if(deferredPrompt && confirm('Deseja instalar o aplicativo Caderneta do Idoso em seu dispositivo para melhor experiência?')) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            console.log('Usuário aceitou a instalação');
          } else {
            console.log('Usuário recusou a instalação');
          }
          deferredPrompt = null;
        });
      }
    }

    const firebaseConfig = {
      apiKey: "AIzaSyCMP_bBotEMngO0pLkxhrZvvgCJqIFTZCY",
      authDomain: "cadernetavirtualdoidoso.firebaseapp.com",
      projectId: "cadernetavirtualdoidoso",
      storageBucket: "cadernetavirtualdoidoso.appspot.com",
      messagingSenderId: "374078415962",
      appId: "1:374078415962:web:8d8566388ee8336f986463"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    let currentDetailTab = 'detail-identificacao';
    let reviewUnsubscribe = null;
    let userDetailUnsubscribe = null;
    let medicalAccessUnsubscribe = null;
    let currentEditingUser = null;
    let isEditing = false;
    let currentUserData = null;
    let examesUnsubscribe = null;
    let cameraStream = null;
    let usingFrontCamera = false;
    let capturedPhotos = [];
    let currentPhotoIndex = 0;

    function generateUsername(nome, dataNascimento) {
      const normalized = nome.toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
        .replace(/\s+/g, '')
        .replace(/[^a-z0-9]/g, '');
      const cleanDate = dataNascimento.replace(/-/g, '');
      return normalized + cleanDate;
    }

    function setupRealtimeUpdates(username) {
      if(reviewUnsubscribe) reviewUnsubscribe();
      return db.collection('usuarios').doc(username).onSnapshot(doc => {
        if(doc.exists) updateReviewScreen(doc.data());
      }, error => {
        console.error('Erro na escuta em tempo real:', error);
      });
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
    }

    async function loadExames(username) {
      try {
        const examesRef = db.collection('exames').where('pacienteId', '==', username);
        const querySnapshot = await examesRef.get();
        
        const examesList = document.getElementById('examesList');
        examesList.innerHTML = '';
        
        if (querySnapshot.empty) {
          examesList.innerHTML = '<p style="text-align: center; color: #666;">Nenhum exame cadastrado ainda.</p>';
          return;
        }
        
        const exames = [];
        querySnapshot.forEach(doc => {
          exames.push({ id: doc.id, ...doc.data() });
        });
        
        // Ordena por data (mais recente primeiro)
        exames.sort((a, b) => new Date(b.data) - new Date(a.data));
        
        exames.forEach(exame => {
          const exameItem = document.createElement('div');
          exameItem.className = 'exame-item';
          
          // Verifica se é um álbum (múltiplas fotos)
          const isAlbum = Array.isArray(exame.url);
          const firstImage = isAlbum ? exame.url[0] : exame.url;
          
          exameItem.innerHTML = `
            <div class="exame-info">
              <img src="${firstImage}" alt="Exame" class="exame-thumbnail" 
                   onclick="showExamePreview('${exame.id}')">
              <div class="exame-details">
                <div class="exame-name">${exame.descricao || 'Exame médico'}</div>
                <div class="exame-date">${formatDate(exame.data)}</div>
                ${isAlbum ? `<div class="exame-album-info"><i class="fas fa-images"></i> ${exame.url.length} fotos</div>` : ''}
              </div>
            </div>
            <div class="exame-actions">
              <button class="exame-action-btn" onclick="deleteExame('${exame.id}')" title="Excluir exame">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          `;
          examesList.appendChild(exameItem);
        });
      } catch (error) {
        console.error('Erro ao carregar exames:', error);
        showPopup('Erro ao carregar exames!', true);
      }
    }

    async function showExamePreview(exameId) {
      try {
        const doc = await db.collection('exames').doc(exameId).get();
        if (!doc.exists) return;
        
        const exameData = doc.data();
        const isAlbum = Array.isArray(exameData.url);
        const images = isAlbum ? exameData.url : [exameData.url];
        
        const modal = document.getElementById('examePreviewModal');
        const img = document.getElementById('examePreviewImage');
        
        // Mostra a primeira imagem
        img.src = images[0];
        modal.style.display = 'flex';
        
        // Se for álbum, mostra controles de navegação
        if (isAlbum && images.length > 1) {
          const carousel = document.createElement('div');
          carousel.className = 'photo-carousel';
          
          images.forEach((image, index) => {
            const thumb = document.createElement('img');
            thumb.src = image;
            thumb.className = 'photo-thumbnail' + (index === 0 ? ' active' : '');
            thumb.onclick = () => {
              img.src = image;
              document.querySelectorAll('.photo-thumbnail').forEach(t => t.classList.remove('active'));
              thumb.classList.add('active');
            };
            carousel.appendChild(thumb);
          });
          
          // Insere o carrossel antes da imagem principal
          img.parentNode.insertBefore(carousel, img);
        }
        
        document.getElementById('closePreviewBtn').onclick = () => {
          modal.style.display = 'none';
        };
      } catch (error) {
        console.error('Erro ao mostrar exame:', error);
        showPopup('Erro ao visualizar exame!', true);
      }
    }

    async function deleteExame(exameId) {
      if(!confirm('Tem certeza que deseja excluir este exame permanentemente?')) return;
      
      try {
        await db.collection('exames').doc(exameId).delete();
        showPopup('Exame excluído com sucesso!');
        
        // Atualiza a lista de exames na tela do paciente
        const username = localStorage.getItem('currentUser');
        if (username) {
          loadExames(username);
        }
        
        // Atualiza também na tela de detalhes do médico, se estiver aberta
        if (document.getElementById('userDetailScreen').style.display === 'block') {
          loadUserExames(currentEditingUser);
        }
      } catch (error) {
        console.error('Erro ao excluir exame:', error);
        showPopup('Erro ao excluir exame!', true);
      }
    }

    function openExamModal() {
      document.getElementById('examModal').style.display = 'block';
    }

    function closeExamModal() {
      document.getElementById('examModal').style.display = 'none';
    }

    async function startCamera(facingMode = 'environment') {
      try {
        stopCamera(); // Para qualquer stream existente
        
        const constraints = {
          video: { 
            facingMode: facingMode,
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        };
        
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        const video = document.getElementById('cameraVideo');
        
        video.srcObject = stream;
        cameraStream = stream;
        document.getElementById('cameraContainer').style.display = 'flex';
        
        video.onloadedmetadata = () => {
          video.play();
        };
        
      } catch (error) {
        console.error('Erro ao acessar câmera:', error);
        showPopup('Não foi possível acessar a câmera. Verifique as permissões.', true);
      }
    }
    
    function stopCamera() {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
      }
      document.getElementById('cameraContainer').style.display = 'none';
    }
    
    function capturePhoto() {
      const video = document.getElementById('cameraVideo');
      const canvas = document.getElementById('cameraCanvas');
      const context = canvas.getContext('2d');
      
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      const photoUrl = canvas.toDataURL('image/jpeg', 0.8);
      capturedPhotos.push(photoUrl);
      showPhotoPreview(photoUrl);
    }
    
    function showPhotoPreview(imageUrl) {
      const previewModal = document.getElementById('photoPreviewModal');
      const previewImage = document.getElementById('previewImage');
      const carousel = document.getElementById('photoCarousel');
      
      previewImage.src = imageUrl;
      currentPhotoIndex = capturedPhotos.length - 1;
      
      // Atualiza o carrossel de miniaturas
      carousel.innerHTML = '';
      capturedPhotos.forEach((photo, index) => {
        const thumb = document.createElement('img');
        thumb.src = photo;
        thumb.className = 'photo-thumbnail' + (index === currentPhotoIndex ? ' active' : '');
        thumb.onclick = () => {
          previewImage.src = photo;
          currentPhotoIndex = index;
          document.querySelectorAll('.photo-thumbnail').forEach(t => t.classList.remove('active'));
          thumb.classList.add('active');
        };
        carousel.appendChild(thumb);
      });
      
      previewModal.style.display = 'block';
    }
    
    function confirmPhoto() {
      document.getElementById('photoPreviewModal').style.display = 'none';
      document.getElementById('examNameDialog').style.display = 'block';
      document.getElementById('examNameInput').focus();
    }
    
    function retakePhoto() {
      if (capturedPhotos.length > 0) {
        capturedPhotos.splice(currentPhotoIndex, 1);
      }
      
      if (capturedPhotos.length > 0) {
        // Mostra a foto anterior
        currentPhotoIndex = Math.max(0, currentPhotoIndex - 1);
        showPhotoPreview(capturedPhotos[currentPhotoIndex]);
      } else {
        // Se não há mais fotos, volta para a câmera
        document.getElementById('photoPreviewModal').style.display = 'none';
        startCamera(usingFrontCamera ? 'user' : 'environment');
      }
    }
    
    function flipCamera() {
      usingFrontCamera = !usingFrontCamera;
      startCamera(usingFrontCamera ? 'user' : 'environment');
    }

    async function takeExamPhoto() {
      capturedPhotos = []; // Reseta as fotos capturadas
      closeExamModal();
      startCamera('environment'); // Usa a câmera traseira por padrão
    }

    async function handleFileUpload(event) {
      closeExamModal();
      const files = event.target.files;
      if (!files || files.length === 0) return;
      
      // Limpa o array de fotos capturadas
      capturedPhotos = [];
      
      // Processa cada arquivo selecionado
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const reader = new FileReader();
        
        await new Promise((resolve) => {
          reader.onload = (e) => {
            capturedPhotos.push(e.target.result);
            resolve();
          };
          reader.readAsDataURL(file);
        });
      }
      
      // Mostra a prévia da primeira foto
      if (capturedPhotos.length > 0) {
        showPhotoPreview(capturedPhotos[0]);
      }
    }

    async function uploadExamToFirebase(images, description) {
      const username = localStorage.getItem('currentUser');
      if (!username) {
        showPopup('Nenhum usuário selecionado!', true);
        return;
      }
      
      try {
        showPopup('Salvando exame...');
        
        const timestamp = new Date().toISOString();
        
        // Salva no Firestore
        await db.collection('exames').add({
          pacienteId: username,
          url: images.length > 1 ? images : images[0], // Array se múltiplas imagens, string se única
          descricao: description || '',
          data: timestamp
        });
        
        showPopup('Exame salvo com sucesso!');
        
        // Atualiza a lista de exames
        loadExames(username);
        
        // Atualiza também na tela de detalhes do médico, se estiver aberta
        if (document.getElementById('userDetailScreen').style.display === 'block') {
          loadUserExames(username);
        }
        
        // Limpa as fotos capturadas
        capturedPhotos = [];
      } catch (error) {
        console.error('Erro ao salvar exame:', error);
        showPopup('Erro ao salvar exame!', true);
      }
    }

    async function loadUserExames(username) {
      try {
        const examesRef = db.collection('exames').where('pacienteId', '==', username);
        const querySnapshot = await examesRef.get();
        
        const examesContainer = document.createElement('div');
        examesContainer.className = 'exames-container';
        
        if (querySnapshot.empty) {
          examesContainer.innerHTML = '<p style="text-align: center; color: #666;">Nenhum exame cadastrado para este paciente.</p>';
        } else {
          const exames = [];
          querySnapshot.forEach(doc => {
            exames.push({ id: doc.id, ...doc.data() });
          });
          
          // Ordena por data (mais recente primeiro)
          exames.sort((a, b) => new Date(b.data) - new Date(a.data));
          
          exames.forEach(exame => {
            const exameItem = document.createElement('div');
            exameItem.className = 'exame-item';
            
            const isAlbum = Array.isArray(exame.url);
            const firstImage = isAlbum ? exame.url[0] : exame.url;
            
            exameItem.innerHTML = `
              <div class="exame-info">
                <img src="${firstImage}" alt="Exame" class="exame-thumbnail" 
                     onclick="showExamePreview('${exame.id}')">
                <div class="exame-details">
                  <div class="exame-name">${exame.descricao || 'Exame médico'}</div>
                  <div class="exame-date">${formatDate(exame.data)}</div>
                  ${isAlbum ? `<div class="exame-album-info"><i class="fas fa-images"></i> ${exame.url.length} fotos</div>` : ''}
                </div>
              </div>
              <div class="exame-actions">
                <button class="exame-action-btn" onclick="deleteExame('${exame.id}')" title="Excluir exame">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            `;
            examesContainer.appendChild(exameItem);
          });
        }
        
        const detailContent = document.getElementById('userDetailContent');
        let examesTab = document.getElementById('detail-exames');
        
        if (!examesTab) {
          examesTab = document.createElement('div');
          examesTab.className = 'detail-tab-content';
          examesTab.id = 'detail-exames';
          detailContent.appendChild(examesTab);
        }
        
        examesTab.innerHTML = '';
        examesTab.appendChild(examesContainer);
        
      } catch (error) {
        console.error('Erro ao carregar exames:', error);
        showPopup('Erro ao carregar exames do paciente!', true);
      }
    }

    // Função modificada para configurar alarmes de medicação
    async function setMedicationAlarm() {
      try {
        // Solicitar permissão para notificações
        if ('Notification' in window) {
          const permission = await Notification.requestPermission();
          if (permission !== 'granted') {
            showPopup('Permissão para notificações não concedida!', true);
            return;
          }
        } else {
          showPopup('Seu navegador não suporta notificações!', true);
          return;
        }
        
        const username = localStorage.getItem('currentUser');
        if (!username) {
          showPopup('Nenhum usuário encontrado!', true);
          return;
        }
        
        const doc = await db.collection('usuarios').doc(username).get();
        if (!doc.exists) {
          showPopup('Dados do usuário não encontrados!', true);
          return;
        }
        
        const medicamentos = doc.data().medicamentos;
        if (!medicamentos || medicamentos.length === 0) {
          showPopup('Nenhum medicamento cadastrado para configurar alarmes!', true);
          return;
        }
        
        // Registrar o Service Worker se ainda não estiver registrado
        if ('serviceWorker' in navigator) {
          try {
            const registration = await navigator.serviceWorker.register('/sw.js');
            console.log('Service Worker registrado com sucesso:', registration);
          } catch (error) {
            console.error('Falha ao registrar Service Worker:', error);
            showPopup('Erro ao configurar alarmes!', true);
            return;
          }
        }
        
        // Armazenar os alarmes no IndexedDB
        const dbName = 'MedicationAlarmsDB';
        const dbVersion = 1;
        
        const request = indexedDB.open(dbName, dbVersion);
        
        request.onerror = (event) => {
          console.error('Erro ao abrir o banco de dados:', event.target.error);
          showPopup('Erro ao configurar alarmes!', true);
        };
        
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains('alarms')) {
            const store = db.createObjectStore('alarms', { keyPath: 'id', autoIncrement: true });
            store.createIndex('timestamp', 'timestamp', { unique: false });
          }
        };
        
        request.onsuccess = (event) => {
          const db = event.target.result;
          const transaction = db.transaction(['alarms'], 'readwrite');
          const store = transaction.objectStore('alarms');
          
          // Limpar alarmes antigos
          store.clear();
          
          const now = new Date();
          let alarmesConfigurados = 0;
          
          medicamentos.forEach((med, index) => {
            if (med.horario) {
              const [hours, minutes] = med.horario.split(':');
              const alarmTime = new Date();
              alarmTime.setHours(hours);
              alarmTime.setMinutes(minutes);
              
              // Se o horário já passou hoje, agenda para amanhã
              if (alarmTime < now) {
                alarmTime.setDate(alarmTime.getDate() + 1);
              }
              
              const timeUntilAlarm = alarmTime.getTime() - now.getTime();
              
              if (timeUntilAlarm > 0) {
                const alarmData = {
                  medicamento: med.nome,
                  dose: med.dose,
                  posologia: med.posologia,
                  horario: med.horario,
                  timestamp: alarmTime.getTime(),
                  notificationId: `med-alarm-${Date.now()}-${index}`
                };
                
                store.add(alarmData);
                alarmesConfigurados++;
                
                // Enviar mensagem para o Service Worker para agendar a notificação
                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                  navigator.serviceWorker.controller.postMessage({
                    type: 'SCHEDULE_NOTIFICATION',
                    alarmData: alarmData
                  });
                }
              }
            }
          });
          
          transaction.oncomplete = () => {
            db.close();
            if (alarmesConfigurados > 0) {
              showPopup(`${alarmesConfigurados} alarme(s) de medicação configurado(s) com sucesso!`);
              
              // Configura o próximo alarme para verificar diariamente
              scheduleDailyAlarmCheck();
            } else {
              showPopup('Nenhum horário de medicação válido encontrado!', true);
            }
          };
          
          transaction.onerror = (event) => {
            console.error('Erro na transação:', event.target.error);
            showPopup('Erro ao configurar alarmes!', true);
          };
        };
      } catch (error) {
        console.error('Erro ao configurar alarmes:', error);
        showPopup('Erro ao configurar alarmes!', true);
      }
    }
    
    function scheduleDailyAlarmCheck() {
      if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
        // Agenda uma verificação diária para recriar os alarmes
        navigator.serviceWorker.controller.postMessage({
          type: 'SCHEDULE_DAILY_CHECK'
        });
      }
    }

    // Restante do código permanece igual...
    // [O restante do código JavaScript permanece exatamente como estava, apenas as funções acima foram modificadas/adicionadas]

    document.addEventListener('DOMContentLoaded', async () => {
      const username = localStorage.getItem('currentUser');
      if(username) {
        reviewUnsubscribe = setupRealtimeUpdates(username);
        const data = await loadUserData(username);
        if(data) {
          updateReviewScreen(data);
          document.getElementById('homeScreen').style.display = 'none';
          document.getElementById('reviewScreen').style.display = 'block';
          
          // Carrega os exames do paciente
          loadExames(username);
        }
      }
      
      // Configura os botões de exames
      document.getElementById('addExamBtn').addEventListener('click', openExamModal);
      document.getElementById('takePhotoBtn').addEventListener('click', takeExamPhoto);
      document.getElementById('uploadPhotoBtn').addEventListener('click', () => {
        document.getElementById('examFileInput').click();
      });
      document.getElementById('closeExamModalBtn').addEventListener('click', closeExamModal);
      document.getElementById('examFileInput').addEventListener('change', handleFileUpload);
      
      // Event listeners para os controles da câmera
      document.getElementById('captureBtn').addEventListener('click', capturePhoto);
      document.getElementById('closeCameraBtn').addEventListener('click', stopCamera);
      document.getElementById('flipCameraBtn').addEventListener('click', flipCamera);
      
      // Event listeners para o diálogo de nome do exame
      document.getElementById('cancelExamNameBtn').addEventListener('click', () => {
        document.getElementById('examNameDialog').style.display = 'none';
        capturedPhotos = [];
      });
      
      document.getElementById('saveExamNameBtn').addEventListener('click', async () => {
        const examName = document.getElementById('examNameInput').value.trim();
        if (!examName) {
          alert('Por favor, digite um nome para o exame');
          return;
        }
        
        document.getElementById('examNameDialog').style.display = 'none';
        document.getElementById('examNameInput').value = '';
        
        if (capturedPhotos.length > 0) {
          await uploadExamToFirebase(capturedPhotos, examName);
          stopCamera();
        }
      });

      // Event listeners para o modal de prévia da foto
      document.getElementById('retakePhotoBtn').addEventListener('click', retakePhoto);
      document.getElementById('confirmPhotoBtn').addEventListener('click', confirmPhoto);
    });

    // Registrar o Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => {
            console.log('Service Worker registrado:', registration.scope);
            
            // Verificar se há notificações pendentes quando a página é carregada
            registration.active.postMessage({
              type: 'CHECK_PENDING_NOTIFICATIONS'
            });
          })
          .catch(error => {
            console.log('Falha no registro:', error);
          });
      });
    }
  </script>
</body>
</html>
