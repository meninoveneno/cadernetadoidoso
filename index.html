<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#4D6057">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="manifest" href="/manifest.json">
  <title>Caderneta Idoso</title>
  <link rel="icon" type="image/png" href="https://i.imgur.com/BzIGz3X.png">
  <link rel="apple-touch-icon" href="https://i.imgur.com/BzIGz3X.png">
  <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-storage-compat.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <style>
    /* Cabe√ßalho de contato simplificado - Modificado para manter em linha em mobile */
    .contact-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background-color: #4D6057;
      color: white;
      padding: 10px 15px;
      font-size: 14px;
      z-index: 1000;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .contact-header a {
      color: white;
      text-decoration: none;
      transition: opacity 0.2s;
      white-space: nowrap;
    }
    
    .contact-header a:hover {
      opacity: 0.8;
      text-decoration: underline;
    }

    .contact-separator {
      display: inline-block;
    }

    /* Estilo para mobile - Modificado para manter em linha */
    @media (max-width: 600px) {
      .contact-header {
        font-size: 12px;
        padding: 8px 5px;
        gap: 8px;
        flex-direction: row;
        justify-content: center;
        flex-wrap: wrap;
      }
      
      .contact-separator {
        display: inline-block;
      }
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 16px;
      margin: 0;
      padding-top: 50px;
      background-color: #f8f9fa;
      color: #333;
    }
    .container {
      max-width: 900px;
      margin: 20px auto;
      background: #fff;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 30px;
      border-radius: 12px;
      position: relative;
    }
    #homeScreen {
      text-align: center;
      padding: 50px 20px;
      background: linear-gradient(135deg, #4D6057, #839c90);
      color: #fff;
      border-radius: 12px;
      position: relative;
    }
    #homeScreen h1 {
      font-size: 36px;
      margin-bottom: 10px;
      font-weight: 600;
    }
    #homeScreen h2 {
      font-size: 20px;
      margin-bottom: 10px;
      font-weight: 400;
    }
    #homeScreen h3 {
      font-size: 18px;
      margin-bottom: 30px;
      font-weight: 400;
      font-style: italic;
    }
    #homeScreen img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      position: absolute;
      left: 20px;
      bottom: 20px;
      border: 3px solid #fff;
    }
    #homeScreen button {
      padding: 12px 20px;
      border: none;
      background: #3b5448;
      color: #fff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: background-color 0.3s;
      width: 100%;
      max-width: 200px;
    }
    #homeScreen button:hover {
      background-color: #2d4036;
    }
    #readQrBtn {
      margin-top: 10px;
      background-color: #839c90;
    }
    #readQrBtn:hover {
      background-color: #6d8a7d;
    }
    .tabs {
      display: flex;
      overflow-x: auto;
      padding: 0;
      list-style: none;
      border-bottom: 2px solid #e9ecef;
      margin-bottom: 20px;
    }
    .tabs li {
      text-align: center;
      padding: 12px 20px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      background-color: #e9ecef;
      border-radius: 8px 8px 0 0;
      transition: all 0.3s ease;
      flex-shrink: 0;
      min-width: 120px;
      margin-right: 8px;
      color: #495057;
    }
    .tabs li.active {
      background-color: #839c90;
      color: white;
      box-shadow: 0 4px 6px rgba(131, 156, 144, 0.2);
    }
    .tabs li:hover {
      background-color: #6d8a7d;
      color: white;
    }
    .tab-content {
      display: none;
      animation: fadeIn 0.5s ease-in-out;
    }
    .tab-content.active {
      display: block;
    }
    form label {
      display: block;
      margin-top: 12px;
      font-size: 16px;
      font-weight: 600;
      color: #495057;
    }
    form input,
    form select,
    form textarea {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      border: 1px solid #ced4da;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }
    form input:focus,
    form select:focus,
    form textarea:focus {
      border-color: #4D6057;
      outline: none;
      box-shadow: 0 0 0 3px rgba(77, 96, 87, 0.1);
    }
    form textarea {
      resize: vertical;
      min-height: 100px;
    }
    .btn {
      margin-top: 20px;
      padding: 12px 20px;
      border: none;
      background: #3b5448;
      color: #fff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: background-color 0.3s;
      width: 100%;
      max-width: 200px;
    }
    .btn:hover {
      background-color: #2d4036;
    }
    #addMedicamento,
    #addVacina {
      background: #4D6057;
      width: 100%;
      max-width: 200px;
    }
    #addMedicamento:hover,
    #addVacina:hover {
      background: #3b5448;
    }
    #monitoramentoBtn {
      background-color: #ffc107;
      color: #333;
    }
    #monitoramentoBtn:hover {
      background-color: #e0a800;
    }
    .popup {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #3b5448;
      color: #fff;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 16px;
      opacity: 0;
      transition: opacity 0.5s;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .popup.show {
      opacity: 1;
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    @media (max-width: 600px) {
      .tabs li {
        font-size: 14px;
        padding: 10px 15px;
        min-width: 100px;
      }
      button,
      form input,
      form select,
      form textarea {
        font-size: 14px;
        padding: 8px;
      }
      form label {
        font-size: 14px;
      }
      .review-buttons {
        flex-direction: column;
        gap: 10px;
      }
      .review-buttons .btn {
        max-width: 100%;
        width: 100%;
      }
      #homeScreen img {
        position: relative;
        left: auto;
        bottom: auto;
        margin: 20px auto;
        display: block;
      }
      body {
        padding-top: 80px;
      }
    }
    .review-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }
    #monitoramentoOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      z-index: 900;
    }
    #monitoramentoScreen {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      z-index: 1000;
      display: none;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    #monitoramentoScreen h3 {
      margin-top: 0;
      color: #333;
    }
    #monitoramentoScreen button {
      margin-top: 10px;
      width: 48%;
    }
    .vacina-form,
    .medicamento-form {
      border: 1px solid #e9ecef;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
      background-color: #f8f9fa;
    }
    .vacina-form .form-row,
    .medicamento-form .form-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    .vacina-form .form-row label,
    .medicamento-form .form-row label {
      flex: 1;
    }
    .vacina-form .form-row input,
    .vacina-form .form-row textarea,
    .medicamento-form .form-row input,
    .medicamento-form .form-row textarea {
      flex: 2;
    }
    .delete-btn {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 10px;
      transition: background-color 0.3s;
    }
    .delete-btn:hover {
      background-color: #c82333;
    }
    .review-container {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    .review-container h3 {
      margin-top: 0;
      color: #4D6057;
    }
    .alarm-btn {
      background-color: #ffc107;
      color: #333;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .alarm-btn:hover {
      background-color: #e0a800;
    }
    .alarm-btn i {
      font-size: 18px;
    }
    #medicalLoginScreen,
    #medicalAccessScreen,
    #userDetailScreen,
    #qrCodeScreen {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 12px;
      width: 95%;
      max-width: 800px;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      text-align: left;
    }
    #userDetailTabs {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 5px;
      margin-bottom: 20px;
    }
    .detail-tab {
      padding: 12px;
      text-align: center;
      background: #e9ecef;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
    }
    .detail-tab.active {
      background: #839c90;
      color: white;
    }
    .detail-tab-content {
      display: none;
      padding: 15px;
      border: 1px solid #eee;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: left;
    }
    .detail-tab-content.active {
      display: block;
    }
    .compact-form {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      text-align: left;
    }
    .scrollable-detail {
      max-height: 60vh;
      overflow-y: auto;
      padding-right: 10px;
      text-align: left;
    }
    .detail-tab-content#detail-monitoramento {
      background-color: #fff9c4;
      padding: 15px;
      border-radius: 8px;
      text-align: left;
    }
    .monitoramento-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin: 5px 0;
      background-color: white;
      border-radius: 8px;
      text-align: left;
    }
    .delete-monitoramento-btn {
      background: #ff4444;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
    }
    #qrCodeScreen input {
      width: 80%;
      max-width: 400px;
      padding: 10px;
      margin: 10px auto;
      border: 1px solid #ddd;
      border-radius: 8px;
      display: block;
    }
    #qrCodeScreen label {
      display: block;
      margin-top: 12px;
      font-size: 16px;
      font-weight: 600;
      color: #495057;
      text-align: left;
    }
    #qrCodeContainer {
      text-align: center;
      margin: 20px 0;
      display: none;
    }
    .medical-search {
      width: 80%;
      max-width: 400px;
      padding: 10px;
      margin: 10px auto;
      border: 1px solid #ddd;
      border-radius: 8px;
      display: block;
    }
    .user-list {
      max-height: 400px;
      overflow-y: auto;
      margin: 15px auto;
      width: 90%;
      max-width: 600px;
      text-align: left;
    }
    .user-item {
      padding: 15px;
      margin: 10px 0;
      background: #f8f9fa;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: left;
    }
    .user-item:hover {
      background: #e9ecef;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .user-name {
      font-weight: 600;
      font-size: 1.1em;
      margin-bottom: 5px;
    }
    .user-details {
      display: flex;
      justify-content: space-between;
      font-size: 0.9em;
      color: #666;
    }
    .medical-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }
    .editable-field {
      border: 1px solid transparent;
      padding: 5px;
      margin: 5px 0;
      transition: all 0.3s;
      text-align: left;
    }
    .editing .editable-field {
      border-color: #4D6057;
      background-color: #f8f9fa;
    }
    .edit-input {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      text-align: left;
    }
    .btn-danger {
      background-color: #dc3545;
    }
    .btn-danger:hover {
      background-color: #c82333;
    }
    .add-item-btn {
      margin: 10px 0;
      background: #4D6057;
    }
    .code-input {
      position: absolute;
      right: 20px;
      bottom: 20px;
      width: 100px;
    }
    #qrScannerModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }
    #qrScannerVideo {
      width: 90%;
      max-width: 500px;
      border-radius: 8px;
    }
    #closeScannerBtn {
      margin-top: 20px;
      background: #dc3545;
    }
    .no-users {
      text-align: center;
      color: #666;
      padding: 20px;
    }
    .exames-container {
      margin-top: 20px;
      border: 1px solid #e9ecef;
      padding: 20px;
      border-radius: 8px;
      background-color: #f8f9fa;
    }
    
    .exames-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      gap: 10px;
    }
    
    .exames-title {
      font-size: 18px;
      font-weight: bold;
      color: #4D6057;
      margin: 0;
    }
    
    .exames-actions {
      display: flex;
      gap: 10px;
    }
    
    .exame-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      margin: 10px 0;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    
    .exame-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .exame-info {
      display: flex;
      align-items: center;
      gap: 15px;
      flex: 1;
    }
    
    .exame-thumbnail {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 4px;
      border: 1px solid #ddd;
      cursor: pointer;
    }
    
    .exame-details {
      flex: 1;
    }
    
    .exame-name {
      font-weight: 500;
      margin-bottom: 5px;
    }
    
    .exame-date {
      font-size: 12px;
      color: #666;
    }
    
    .exame-actions {
      display: flex;
      gap: 8px;
    }
    
    .exame-action-btn {
      background: none;
      border: none;
      color: #4D6057;
      cursor: pointer;
      font-size: 16px;
      transition: color 0.2s;
    }
    
    .exame-action-btn:hover {
      color: #3b5448;
    }
    
    .exame-preview {
      max-width: 100%;
      max-height: 300px;
      margin: 10px 0;
      display: none;
      border-radius: 4px;
    }
    
    #examePreviewModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    #examePreviewImage {
      max-width: 90%;
      max-height: 90%;
      border-radius: 4px;
    }
    
    #closePreviewBtn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #dc3545;
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 18px;
    }
    .action-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
    }
    
    .action-btn {
      flex: 1;
      min-width: 120px;
      padding: 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .action-btn i {
      font-size: 16px;
    }
    
    .btn-primary {
      background-color: #4D6057;
      color: white;
    }
    
    .btn-primary:hover {
      background-color: #3b5448;
    }
    
    .btn-secondary {
      background-color: #839c90;
      color: white;
    }
    
    .btn-secondary:hover {
      background-color: #6d8a7d;
    }
    
    .btn-warning {
      background-color: #ffc107;
      color: #333;
    }
    
    .btn-warning:hover {
      background-color: #e0a800;
    }
    
    .btn-danger {
      background-color: #dc3545;
      color: white;
    }
    
    .btn-danger:hover {
      background-color: #c82333;
    }
    
    .exam-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 12px;
      z-index: 1000;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      display: none;
    }
    
    .exam-modal h3 {
      margin-top: 0;
      color: #4D6057;
      text-align: center;
    }
    
    .exam-modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .exam-modal-actions .action-btn {
      flex: 1;
    }
    
    @media (max-width: 600px) {
      .exame-info {
        gap: 10px;
      }
      
      .exame-thumbnail {
        width: 50px;
        height: 50px;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .action-btn {
        width: 100%;
      }
    }
    #medicalLoginScreen h2,
    #medicalAccessScreen h2,
    #qrCodeScreen h2 {
      text-align: center;
      margin-bottom: 20px;
    }

    #qrCodeScreen form {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #qrCodeScreen label {
      text-align: center;
      width: 100%;
    }

    #qrCodeScreen input {
      text-align: center;
    }

    #medicalLoginScreen,
    #medicalAccessScreen,
    #qrCodeScreen {
      text-align: left;
    }

    @media (max-width: 600px) {
      #userDetailTabs {
        grid-template-columns: 1fr;
      }
      .detail-tab {
        font-size: 13px;
        padding: 10px;
      }
      .compact-form {
        grid-template-columns: 1fr;
      }
      .user-details {
        flex-direction: column;
      }
      .medical-search {
        width: 90%;
      }
    }
  </style>
</head>
<body>
  <!-- Cabe√ßalho de contato simplificado - Modificado para manter em linha em mobile -->
  <div class="contact-header">
    <a href="https://www.instagram.com/camillaribeirogeriatra" target="_blank" title="Acessar Instagram">
      <i class="fab fa-instagram"></i> @camillaribeirogeriatra
    </a>
    <span class="contact-separator">|</span>
    <a href="https://wa.me/5538999037071" title="Enviar mensagem no WhatsApp">
      <i class="fab fa-whatsapp"></i> (38) 99903-7071
    </a>
  </div>

  <!-- Tela Inicial -->
  <div id="homeScreen" class="container">
    <h1>Caderneta Virtual do Idoso</h1>
    <h2>Cuidar hoje para viver melhor amanh√£!</h2>
    <h3>Dra. Camilla Ribeiro | CRM: 57634 RQE: 42473</h3>
    <img src="https://i.imgur.com/BzIGz3X.png" alt="Logo">
    <button id="startBtn">Iniciar</button>
    <button id="readQrBtn">Ler QR Code</button>
  </div>

  <!-- Tela de Edi√ß√£o -->
  <div id="editScreen" class="container" style="display: none;">
    <ul class="tabs">
      <li class="tab active" data-tab="identificacao">Identifica√ß√£o</li>
      <li class="tab" data-tab="vacinacao">Vacina√ß√£o</li>
      <li class="tab" data-tab="doencas">Doen√ßas Cr√¥nicas</li>
      <li class="tab" data-tab="medicamentos">Medicamentos</li>
      <li class="tab" data-tab="recomendacoes">Anota√ß√µes</li>
    </ul>

    <div class="tab-content active" id="identificacao">
      <form id="form-identificacao">
        <label for="nome">Nome:</label>
        <input type="text" id="nome" name="nome">
        <label for="dataNascimento">Data de Nascimento:</label>
        <input type="date" id="dataNascimento" name="dataNascimento">
        <label for="peso">Peso (kg):</label>
        <input type="number" id="peso" name="peso">
        <label for="contato">Contato:</label>
        <input type="tel" id="contato" name="contato">
        <label for="contatoEmergencia">Contato de Emerg√™ncia:</label>
        <input type="tel" id="contatoEmergencia" name="contatoEmergencia">
      </form>
    </div>

    <div class="tab-content" id="vacinacao">
      <div id="vacinasContainer">
        <div class="vacina-form">
          <div class="form-row">
            <label for="nomeVacina">Nome da Vacina:</label>
            <input type="text" class="nomeVacina" name="nomeVacina[]">
          </div>
          <div class="form-row">
            <label for="dataAplicacao">Data de Aplica√ß√£o:</label>
            <input type="date" class="dataAplicacao" name="dataAplicacao[]">
          </div>
          <div class="form-row">
            <label for="loteVacina">Lote:</label>
            <input type="text" class="loteVacina" name="loteVacina[]">
          </div>
          <div class="form-row">
            <label for="observacoesVacina">Observa√ß√µes:</label>
            <textarea class="observacoesVacina" name="observacoesVacina[]"></textarea>
          </div>
          <button type="button" class="delete-btn" onclick="deleteVacinaForm(this)">Excluir Vacina</button>
        </div>
      </div>
      <button type="button" id="addVacina" class="btn">Adicionar Vacina</button>
    </div>

    <div class="tab-content" id="doencas">
      <form id="form-doencas">
        <label><input type="checkbox" id="hipertensao" name="hipertensao"> Hipertens√£o</label>
        <label><input type="checkbox" id="diabetes" name="diabetes"> Diabetes</label>
        <label><input type="checkbox" id="cardiopatias" name="cardiopatias"> Cardiopatias</label>
        <label><input type="checkbox" id="chagas" name="chagas"> Chagas</label>
        <label for="outrasDoencas">Outras Doen√ßas/Alergias:</label>
        <input type="text" id="outrasDoencas" name="outrasDoencas">
      </form>
    </div>

    <div class="tab-content" id="medicamentos">
      <form id="form-medicamentos">
        <div id="medicamentosContainer">
          <div class="medicamento-form">
            <label>Nome do Medicamento:</label>
            <input type="text" name="nomeMedicamento[]">
            <label>Dose:</label>
            <input type="text" name="doseMedicamento[]">
            <label>Posologia:</label>
            <input type="text" name="posologiaMedicamento[]">
            <label>Hor√°rio:</label>
            <input type="time" name="horarioMedicamento[]">
            <button type="button" class="delete-btn" onclick="deleteMedicamentoForm(this)">Excluir Medicamento</button>
          </div>
        </div>
        <button type="button" id="addMedicamento" class="btn">Adicionar Medicamento</button>
      </form>
    </div>

    <div class="tab-content" id="recomendacoes">
      <form id="form-recomendacoes">
        <label for="anotacoes">Anota√ß√µes M√©dicas:</label>
        <textarea id="anotacoes" name="anotacoes"></textarea>
      </form>
    </div>

    <button id="saveBtn" class="btn">Salvar Dados</button>
    <div id="popup" class="popup">Dados salvos com sucesso!</div>
  </div>

  <!-- Tela de Revis√£o -->
  <div id="reviewScreen" class="container" style="display: none;">
    <h2>Dados do Idoso</h2>
    <div class="review-container">
      <h3>Identifica√ß√£o</h3>
      <div id="reviewIdentificacao"></div>
    </div>
    <div class="review-container">
      <h3>Vacina√ß√£o</h3>
      <div id="reviewVacinacao"></div>
    </div>
    <div class="review-container">
      <h3>Doen√ßas Cr√¥nicas e Alergias</h3>
      <div id="reviewDoencas"></div>
    </div>
    <div class="review-container">
      <h3>Medicamentos em Uso</h3>
      <div id="reviewMedicamentos"></div>
      <button class="alarm-btn" onclick="setMedicationAlarm()">
        <i class="fas fa-clock"></i>
        Definir alarme para medica√ß√µes
      </button>
    </div>
    <div class="review-container">
      <h3>Mapeamento de PA e Glicemia</h3>
      <div id="reviewMonitoramento"></div>
    </div>
    <div class="review-container">
      <h3>Recomenda√ß√µes/Anota√ß√µes M√©dicas</h3>
      <div id="reviewAnotacoes"></div>
    </div>
    
    <!-- Se√ß√£o de Exames melhorada -->
    <div class="review-container">
      <h3>Exames</h3>
      <div class="exames-container">
        <div class="exames-header">
          <div class="exames-title">Documentos e Exames</div>
          <div class="exames-actions">
            <button id="addExamBtn" class="action-btn btn-primary">
              <i class="fas fa-plus"></i> Adicionar Exame
            </button>
          </div>
        </div>
        <div id="examesList"></div>
      </div>
    </div>
    
    <div class="review-buttons">
      <button id="exportBtn" class="btn">Exportar</button>
      <button id="monitoramentoBtn" class="btn">Monitoramento</button>
      <button id="medicalAccessBtn" class="btn">Acesso M√©dico</button>
      <button id="editBtn" class="btn">Editar</button>
      <button id="deleteAllBtn" class="btn btn-danger">
        <i class="fas fa-trash"></i> Excluir todos os dados
      </button>
    </div>
  </div>

  <!-- Tela de Login M√©dico -->
  <div id="medicalLoginScreen">
    <h2>Acesso M√©dico</h2>
    <input type="text" id="medUsername" placeholder="Usu√°rio" class="medical-search">
    <input type="password" id="medPassword" placeholder="Senha" class="medical-search">
    <div class="medical-buttons">
      <button id="medLoginBtn" class="btn">Entrar</button>
      <button id="medBackBtn" class="btn">Voltar</button>
    </div>
  </div>

  <!-- Tela de Acesso M√©dico -->
  <div id="medicalAccessScreen">
    <h2>Acesso M√©dico</h2>
    <input type="text" id="userSearch" placeholder="Pesquisar usu√°rios..." class="medical-search">
    <div class="user-list" id="userList"></div>
    <div class="medical-buttons">
      <button id="generateQrBtn" class="btn">Gerar QR CODE</button>
      <button id="medLogoutBtn" class="btn">Sair</button>
    </div>
  </div>

  <!-- Tela de Gera√ß√£o de QR Code -->
  <div id="qrCodeScreen">
    <h2>Gerar Novo Registro</h2>
    <form id="qrCodeForm">
      <label for="qrNome">Nome do Paciente:</label>
      <input type="text" id="qrNome" required>
      
      <label for="qrNascimento">Data de Nascimento:</label>
      <input type="date" id="qrNascimento" required>
      
      <div id="qrCodeContainer">
        <canvas id="qrCanvas"></canvas>
        <p style="margin-top: 10px;">Escaneie este QR code para cadastrar automaticamente</p>
      </div>
      
      <div class="medical-buttons">
        <button type="button" id="generateQrCodeBtn" class="btn">Gerar QR</button>
        <button type="button" id="closeQrBtn" class="btn">Fechar</button>
      </div>
    </form>
  </div>

  <!-- Tela de Detalhes do Paciente -->
  <div id="userDetailScreen">
    <h2>Detalhes do Paciente</h2>
    <div id="userDetailTabs">
      <div class="detail-tab active" data-tab="detail-identificacao">Identifica√ß√£o</div>
      <div class="detail-tab" data-tab="detail-vacinacao">Vacina√ß√£o</div>
      <div class="detail-tab" data-tab="detail-doencas">Doen√ßas</div>
      <div class="detail-tab" data-tab="detail-medicamentos">Medicamentos</div>
      <div class="detail-tab" data-tab="detail-anotacoes">Anota√ß√µes</div>
      <div class="detail-tab" data-tab="detail-monitoramento">Monitoramento</div>
      <div class="detail-tab" data-tab="detail-exames">Exames</div>
    </div>
    
    <div class="scrollable-detail">
      <div id="userDetailContent"></div>
    </div>

    <div class="medical-buttons">
      <button id="editUserBtn" class="btn" onclick="toggleEditMode()">Editar</button>
      <button id="saveUserBtn" class="btn" style="display: none;" onclick="saveUserChanges()">Salvar</button>
      <button class="btn btn-danger" onclick="deleteUser()">Excluir Usu√°rio</button>
      <button onclick="closeUserDetail()" class="btn">Voltar</button>
    </div>
  </div>

  <!-- Overlay e Tela de Monitoramento -->
  <div id="monitoramentoOverlay"></div>
  <div id="monitoramentoScreen">
    <h3>Mapeamento de PA e Glicemia</h3>
    <form id="form-monitoramento">
      <label for="paMonitor">Press√£o Arterial (PA):</label>
      <input type="text" id="paMonitor" name="paMonitor" placeholder="ex: 120/80">
      <label for="glicemiaMonitor">Glicemia:</label>
      <input type="number" id="glicemiaMonitor" name="glicemiaMonitor">
      <div style="display: flex; justify-content: space-between;">
        <button type="button" id="saveMonitorBtn" class="btn">Salvar Monitoramento</button>
        <button type="button" id="closeMonitorBtn" class="btn">Fechar</button>
      </div>
    </form>
  </div>

  <!-- Modal para Scanner de QR Code -->
  <div id="qrScannerModal">
    <video id="qrScannerVideo" playsinline></video>
    <button id="closeScannerBtn" class="btn">Fechar Scanner</button>
  </div>
  
  <!-- Modal para visualiza√ß√£o de exames -->
  <div id="examePreviewModal">
    <button id="closePreviewBtn"><i class="fas fa-times"></i></button>
    <img id="examePreviewImage" src="" alt="Visualiza√ß√£o do Exame">
  </div>
  
  <!-- Modal para upload/tirar foto de exames -->
  <div id="examModal" class="exam-modal">
    <h3>Adicionar Exame</h3>
    <p>Escolha como deseja adicionar o exame:</p>
    <div class="exam-modal-actions">
      <button id="takePhotoBtn" class="action-btn btn-primary">
        <i class="fas fa-camera"></i> Tirar Foto
      </button>
      <button id="uploadPhotoBtn" class="action-btn btn-secondary">
        <i class="fas fa-upload"></i> Upload
      </button>
    </div>
    <button id="closeExamModalBtn" class="action-btn btn-danger" style="margin-top: 10px;">
      <i class="fas fa-times"></i> Cancelar
    </button>
  </div>

  <!-- Input oculto para upload de arquivos -->
  <input type="file" id="examFileInput" accept="image/*" style="display: none;">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // Adicionando o prompt de instala√ß√£o do PWA
    let deferredPrompt;
    
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      showInstallPrompt();
    });
    
    function showInstallPrompt() {
      if(deferredPrompt && confirm('Deseja instalar o aplicativo Caderneta do Idoso em seu dispositivo para melhor experi√™ncia?')) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            console.log('Usu√°rio aceitou a instala√ß√£o');
          } else {
            console.log('Usu√°rio recusou a instala√ß√£o');
          }
          deferredPrompt = null;
        });
      }
    }

    const firebaseConfig = {
      apiKey: "AIzaSyCMP_bBotEMngO0pLkxhrZvvgCJqIFTZCY",
      authDomain: "cadernetavirtualdoidoso.firebaseapp.com",
      projectId: "cadernetavirtualdoidoso",
      storageBucket: "cadernetavirtualdoidoso.appspot.com",
      messagingSenderId: "374078415962",
      appId: "1:374078415962:web:8d8566388ee8336f986463"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    let currentDetailTab = 'detail-identificacao';
    let reviewUnsubscribe = null;
    let userDetailUnsubscribe = null;
    let medicalAccessUnsubscribe = null;
    let currentEditingUser = null;
    let isEditing = false;
    let currentUserData = null;
    let examesUnsubscribe = null;

    function generateUsername(nome, dataNascimento) {
      const normalized = nome.toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
        .replace(/\s+/g, '')
        .replace(/[^a-z0-9]/g, '');
      const cleanDate = dataNascimento.replace(/-/g, '');
      return normalized + cleanDate;
    }

    function setupRealtimeUpdates(username) {
      if(reviewUnsubscribe) reviewUnsubscribe();
      return db.collection('usuarios').doc(username).onSnapshot(doc => {
        if(doc.exists) updateReviewScreen(doc.data());
      }, error => {
        console.error('Erro na escuta em tempo real:', error);
      });
    }

    // Fun√ß√µes para gerenciar exames
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
    }

    async function loadExames(username) {
      try {
        const examesRef = db.collection('usuarios').doc(username).collection('exames');
        const snapshot = await examesRef.orderBy('data', 'desc').get();
        
        const examesList = document.getElementById('examesList');
        examesList.innerHTML = '';
        
        if (snapshot.empty) {
          examesList.innerHTML = '<p style="text-align: center; color: #666;">Nenhum exame cadastrado ainda.</p>';
          return;
        }
        
        snapshot.forEach(doc => {
          const exame = doc.data();
          const exameItem = document.createElement('div');
          exameItem.className = 'exame-item';
          exameItem.innerHTML = `
            <div class="exame-info">
              <img src="${exame.url}" alt="Exame" class="exame-thumbnail" 
                   onclick="showExamePreview('${exame.url}')">
              <div class="exame-details">
                <div class="exame-name">${exame.descricao || 'Exame m√©dico'}</div>
                <div class="exame-date">${formatDate(exame.data)}</div>
              </div>
            </div>
            <div class="exame-actions">
              <button class="exame-action-btn" onclick="deleteExame('${username}', '${doc.id}')" title="Excluir exame">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          `;
          examesList.appendChild(exameItem);
        });
      } catch (error) {
        console.error('Erro ao carregar exames:', error);
        showPopup('Erro ao carregar exames!', true);
      }
    }

    function showExamePreview(imageUrl) {
      const modal = document.getElementById('examePreviewModal');
      const img = document.getElementById('examePreviewImage');
      img.src = imageUrl;
      modal.style.display = 'flex';
      
      document.getElementById('closePreviewBtn').onclick = () => {
        modal.style.display = 'none';
      };
    }

    async function deleteExame(username, exameId) {
      if(!confirm('Tem certeza que deseja excluir este exame permanentemente?')) return;
      
      try {
        // Primeiro deleta o arquivo no Storage
        const exameDoc = await db.collection('usuarios').doc(username).collection('exames').doc(exameId).get();
        if(exameDoc.exists) {
          const exameData = exameDoc.data();
          const fileRef = storage.refFromURL(exameData.url);
          await fileRef.delete();
        }
        
        // Depois deleta o documento no Firestore
        await db.collection('usuarios').doc(username).collection('exames').doc(exameId).delete();
        
        showPopup('Exame exclu√≠do com sucesso!');
        loadExames(username);
        
        // Atualiza tamb√©m na tela de detalhes do m√©dico, se estiver aberta
        if (document.getElementById('userDetailScreen').style.display === 'block') {
          loadUserExames(username);
        }
      } catch (error) {
        console.error('Erro ao excluir exame:', error);
        showPopup('Erro ao excluir exame!', true);
      }
    }

    function openExamModal() {
      document.getElementById('examModal').style.display = 'block';
    }

    function closeExamModal() {
      document.getElementById('examModal').style.display = 'none';
    }

    async function takeExamPhoto() {
      closeExamModal();
      
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert('Seu navegador n√£o suporta acesso √† c√¢mera ou n√£o tem permiss√£o.');
        return;
      }
      
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        const video = document.createElement('video');
        video.srcObject = stream;
        video.play();
        
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        
        return new Promise((resolve) => {
          video.addEventListener('canplay', () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const imageData = canvas.toDataURL('image/jpeg');
            stream.getTracks().forEach(track => track.stop());
            
            // Pergunta pela descri√ß√£o e faz upload
            const description = prompt('Descreva o exame (opcional):');
            uploadExamToFirebase(imageData, description);
          });
        });
      } catch (error) {
        console.error('Erro ao acessar c√¢mera:', error);
        showPopup('Erro ao acessar c√¢mera!', true);
        return null;
      }
    }

    async function handleFileUpload(event) {
      closeExamModal();
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = async (e) => {
        const description = prompt('Descreva o exame (opcional):');
        uploadExamToFirebase(e.target.result, description);
      };
      reader.readAsDataURL(file);
    }

    async function uploadExamToFirebase(imageData, description) {
      const username = localStorage.getItem('currentUser');
      if (!username) {
        showPopup('Nenhum usu√°rio selecionado!', true);
        return;
      }
      
      try {
        showPopup('Enviando exame...');
        
        const timestamp = new Date().toISOString();
        const fileName = `exames/${username}/${Date.now()}.jpg`;
        const storageRef = storage.ref(fileName);
        
        // Converte base64 para blob
        const blob = await fetch(imageData).then(res => res.blob());
        
        // Faz upload para o Firebase Storage
        const snapshot = await storageRef.put(blob);
        const downloadURL = await snapshot.ref.getDownloadURL();
        
        // Salva metadados no Firestore
        await db.collection('usuarios').doc(username).collection('exames').add({
          url: downloadURL,
          descricao: description || '',
          data: timestamp
        });
        
        showPopup('Exame salvo com sucesso!');
        loadExames(username);
        
        // Atualiza tamb√©m na tela de detalhes do m√©dico, se estiver aberta
        if (document.getElementById('userDetailScreen').style.display === 'block') {
          loadUserExames(username);
        }
      } catch (error) {
        console.error('Erro no upload do exame:', error);
        showPopup('Erro ao salvar exame!', true);
      }
    }

    async function loadUserExames(username) {
      try {
        const examesRef = db.collection('usuarios').doc(username).collection('exames');
        const snapshot = await examesRef.orderBy('data', 'desc').get();
        
        const examesContainer = document.createElement('div');
        examesContainer.className = 'exames-container';
        
        if (snapshot.empty) {
          examesContainer.innerHTML = '<p style="text-align: center; color: #666;">Nenhum exame cadastrado para este paciente.</p>';
        } else {
          snapshot.forEach(doc => {
            const exame = doc.data();
            const exameItem = document.createElement('div');
            exameItem.className = 'exame-item';
            exameItem.innerHTML = `
              <div class="exame-info">
                <img src="${exame.url}" alt="Exame" class="exame-thumbnail" 
                     onclick="showExamePreview('${exame.url}')">
                <div class="exame-details">
                  <div class="exame-name">${exame.descricao || 'Exame m√©dico'}</div>
                  <div class="exame-date">${formatDate(exame.data)}</div>
                </div>
              </div>
              <div class="exame-actions">
                <button class="exame-action-btn" onclick="deleteExame('${username}', '${doc.id}')" title="Excluir exame">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            `;
            examesContainer.appendChild(exameItem);
          });
        }
        
        // Adiciona a se√ß√£o de exames ao conte√∫do de detalhes
        const detailContent = document.getElementById('userDetailContent');
        let examesTab = document.getElementById('detail-exames');
        
        if (!examesTab) {
          examesTab = document.createElement('div');
          examesTab.className = 'detail-tab-content';
          examesTab.id = 'detail-exames';
          detailContent.appendChild(examesTab);
        }
        
        examesTab.innerHTML = '';
        examesTab.appendChild(examesContainer);
        
      } catch (error) {
        console.error('Erro ao carregar exames:', error);
        showPopup('Erro ao carregar exames do paciente!', true);
      }
    }

    document.getElementById('startBtn').addEventListener('click', () => {
      document.getElementById('homeScreen').style.display = 'none';
      document.getElementById('editScreen').style.display = 'block';
      if (document.documentElement.requestFullscreen) {
        document.documentElement.requestFullscreen();
      }
    });

    document.getElementById('readQrBtn').addEventListener('click', startQRScanner);

    function startQRScanner() {
      const modal = document.getElementById('qrScannerModal');
      const video = document.getElementById('qrScannerVideo');
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      let stream = null;
      let scanInterval = null;
      
      modal.style.display = 'flex';
      
      if ('BarcodeDetector' in window) {
        startNativeScanner();
      } 
      else if (typeof jsQR !== 'undefined') {
        startJsQRScanner();
      }
      else {
        showUnsupportedMessage();
        return;
      }

      function startNativeScanner() {
        const barcodeDetector = new BarcodeDetector({ formats: ['qr_code'] });
        
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
          .then(s => {
            stream = s;
            video.srcObject = s;
            video.play();
            
            function detectQR() {
              if (!video.videoWidth) {
                requestAnimationFrame(detectQR);
                return;
              }
              
              barcodeDetector.detect(video)
                .then(barcodes => {
                  if (barcodes.length > 0) {
                    handleQRCode(barcodes[0].rawValue);
                  }
                  requestAnimationFrame(detectQR);
                })
                .catch(err => {
                  console.error('Erro na detec√ß√£o nativa:', err);
                  if (typeof jsQR !== 'undefined') {
                    startJsQRScanner();
                  } else {
                    showUnsupportedMessage();
                    stopScanner();
                  }
                });
            }
            
            detectQR();
          })
          .catch(err => {
            console.error('Erro ao acessar c√¢mera:', err);
            showCameraError();
          });
      }

      function startJsQRScanner() {
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
          .then(s => {
            stream = s;
            video.srcObject = s;
            video.play();
            
            function setupCanvas() {
              canvas.width = video.videoWidth;
              canvas.height = video.videoHeight;
            }
            
            scanInterval = setInterval(() => {
              if (video.readyState === video.HAVE_ENOUGH_DATA) {
                if (canvas.width !== video.videoWidth || canvas.height !== video.videoHeight) {
                  setupCanvas();
                }
                
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                
                if (code) {
                  handleQRCode(code.data);
                }
              }
            }, 200);
          })
          .catch(err => {
            console.error('Erro ao acessar c√¢mera:', err);
            showCameraError();
          });
      }

      function handleQRCode(qrData) {
        try {
          const data = JSON.parse(qrData);
          fillFormFromQR(data);
          stopScanner();
        } catch (e) {
          console.error('Erro ao ler QR Code:', e);
          showPopup('QR Code inv√°lido!', true);
        }
      }

      function showUnsupportedMessage() {
        alert('Seu navegador n√£o suporta leitura de QR Code. \n\nRecomendamos usar:\n- Google Chrome\n- Microsoft Edge\n- Mozilla Firefox\n\nVers√µes recentes desses navegadores t√™m melhor suporte.');
        stopScanner();
      }

      function showCameraError() {
        alert('N√£o foi poss√≠vel acessar a c√¢mera. Por favor:\n1. Verifique as permiss√µes do site\n2. Certifique-se que nenhum outro app est√° usando a c√¢mera\n3. Tente novamente');
        stopScanner();
      }

      function stopScanner() {
        if (scanInterval) clearInterval(scanInterval);
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
        }
        modal.style.display = 'none';
      }

      document.getElementById('closeScannerBtn').addEventListener('click', stopScanner);
    }

    function fillFormFromQR(data) {
      if (data.nome) document.getElementById('nome').value = data.nome;
      if (data.dataNascimento) document.getElementById('dataNascimento').value = data.dataNascimento;
      if (data.peso) document.getElementById('peso').value = data.peso;
      if (data.contato) document.getElementById('contato').value = data.contato;
      if (data.contatoEmergencia) document.getElementById('contatoEmergencia').value = data.contatoEmergencia;
      
      document.getElementById('homeScreen').style.display = 'none';
      document.getElementById('editScreen').style.display = 'block';
      
      showPopup('Dados do paciente carregados do QR Code!');
    }

    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.getAttribute('data-tab')).classList.add('active');
      });
    });

    document.getElementById('addMedicamento').addEventListener('click', () => {
      const container = document.getElementById('medicamentosContainer');
      const newBlock = document.createElement('div');
      newBlock.classList.add('medicamento-form');
      newBlock.innerHTML = `
        <label>Nome do Medicamento:</label>
        <input type="text" name="nomeMedicamento[]">
        <label>Dose:</label>
        <input type="text" name="doseMedicamento[]">
        <label>Posologia:</label>
        <input type="text" name="posologiaMedicamento[]">
        <label>Hor√°rio:</label>
        <input type="time" name="horarioMedicamento[]">
        <button type="button" class="delete-btn" onclick="deleteMedicamentoForm(this)">Excluir Medicamento</button>
      `;
      container.appendChild(newBlock);
    });

    document.getElementById('addVacina').addEventListener('click', () => {
      const container = document.getElementById('vacinasContainer');
      const newBlock = document.createElement('div');
      newBlock.classList.add('vacina-form');
      newBlock.innerHTML = `
        <div class="form-row">
          <label>Nome da Vacina:</label>
          <input type="text" class="nomeVacina" name="nomeVacina[]">
        </div>
        <div class="form-row">
          <label>Data de Aplica√ß√£o:</label>
          <input type="date" class="dataAplicacao" name="dataAplicacao[]">
        </div>
        <div class="form-row">
          <label>Lote:</label>
          <input type="text" class="loteVacina" name="loteVacina[]">
        </div>
        <div class="form-row">
          <label>Observa√ß√µes:</label>
          <textarea class="observacoesVacina" name="observacoesVacina[]"></textarea>
        </div>
        <button type="button" class="delete-btn" onclick="deleteVacinaForm(this)">Excluir Vacina</button>
      `;
      container.appendChild(newBlock);
    });

    function deleteMedicamentoForm(button) {
      if (confirm("Tem certeza que deseja excluir este medicamento?")) {
        const form = button.closest('.medicamento-form');
        form.remove();
      }
    }

    function deleteVacinaForm(button) {
      if (confirm("Tem certeza que deseja excluir esta vacina?")) {
        const form = button.closest('.vacina-form');
        form.remove();
      }
    }

    document.getElementById('saveBtn').addEventListener('click', async () => {
      const nome = document.getElementById('nome').value;
      const dataNascimento = document.getElementById('dataNascimento').value;
      
      if(!nome || !dataNascimento) {
        alert('Nome e data de nascimento s√£o obrigat√≥rios!');
        return;
      }

      const username = generateUsername(nome, dataNascimento);
      
      const formData = {
        identificacao: {
          nome: nome,
          dataNascimento: dataNascimento,
          peso: document.getElementById('peso').value,
          contato: document.getElementById('contato').value,
          contatoEmergencia: document.getElementById('contatoEmergencia').value
        },
        vacinacao: Array.from(document.querySelectorAll('.vacina-form')).map(form => ({
          nomeVacina: form.querySelector('.nomeVacina').value,
          dataAplicacao: form.querySelector('.dataAplicacao').value,
          loteVacina: form.querySelector('.loteVacina').value,
          observacoes: form.querySelector('.observacoesVacina').value
        })),
        doencas: {
          hipertensao: document.getElementById('hipertensao').checked,
          diabetes: document.getElementById('diabetes').checked,
          cardiopatias: document.getElementById('cardiopatias').checked,
          chagas: document.getElementById('chagas').checked,
          outras: document.getElementById('outrasDoencas').value
        },
        medicamentos: Array.from(document.querySelectorAll('.medicamento-form')).map(form => ({
          nome: form.querySelector('input[name="nomeMedicamento[]"]').value,
          dose: form.querySelector('input[name="doseMedicamento[]"]').value,
          posologia: form.querySelector('input[name="posologiaMedicamento[]"]').value,
          horario: form.querySelector('input[name="horarioMedicamento[]"]').value
        })),
        anotacoes: document.getElementById('anotacoes').value,
        monitoramento: []
      };

      try {
        await db.collection('usuarios').doc(username).set(formData);
        localStorage.setItem('currentUser', username);
        
        reviewUnsubscribe = setupRealtimeUpdates(username);
        document.getElementById('editScreen').style.display = 'none';
        document.getElementById('reviewScreen').style.display = 'block';
        
        // Carrega os exames do paciente
        loadExames(username);
        
        showPopup('Dados salvos com sucesso!');
      } catch (error) {
        console.error('Erro ao salvar dados:', error);
        showPopup('Erro ao salvar dados!', true);
      }
    });

    function updateReviewScreen(data) {
      document.getElementById('reviewIdentificacao').innerHTML = `
        <p><strong>Nome:</strong> ${data.identificacao.nome}</p>
        <p><strong>Nascimento:</strong> ${data.identificacao.dataNascimento}</p>
        <p><strong>Peso:</strong> ${data.identificacao.peso} kg</p>
        <p><strong>Contato:</strong> ${data.identificacao.contato}</p>
        <p><strong>Emerg√™ncia:</strong> ${data.identificacao.contatoEmergencia}</p>
      `;

      document.getElementById('reviewVacinacao').innerHTML = data.vacinacao.map(vacina => `
        <div class="review-item">
          <p><strong>${vacina.nomeVacina}</strong></p>
          <p>Data: ${vacina.dataAplicacao}</p>
          <p>Lote: ${vacina.loteVacina}</p>
          <p>Observa√ß√µes: ${vacina.observacoes}</p>
        </div>
      `).join('');

      const doencas = [];
      if(data.doencas.hipertensao) doencas.push('Hipertens√£o');
      if(data.doencas.diabetes) doencas.push('Diabetes');
      if(data.doencas.cardiopatias) doencas.push('Cardiopatias');
      if(data.doencas.chagas) doencas.push('Chagas');
      if(data.doencas.outras) doencas.push(data.doencas.outras);
      document.getElementById('reviewDoencas').innerHTML = doencas.join(', ') || 'Nenhuma doen√ßa registrada';

      document.getElementById('reviewMedicamentos').innerHTML = data.medicamentos.map(med => `
        <div class="review-item">
          <p><strong>${med.nome}</strong></p>
          <p>Dose: ${med.dose}</p>
          <p>Posologia: ${med.posologia}</p>
          <p>Hor√°rio: ${med.horario}</p>
        </div>
      `).join('');

      document.getElementById('reviewAnotacoes').innerHTML = data.anotacoes || 'Nenhuma anota√ß√£o registrada';

      document.getElementById('reviewMonitoramento').innerHTML = data.monitoramento?.map(entry => `
        <div class="review-item">
          <p><strong>Press√£o Arterial:</strong> ${entry.pa}</p>
          <p><strong>Glicemia:</strong> ${entry.glicemia} mg/dL</p>
          <p><em>Registrado em: ${new Date(entry.timestamp).toLocaleString()}</em></p>
          <button class="delete-btn" onclick="deleteMonitoramentoEntry('${localStorage.getItem('currentUser')}', '${entry.timestamp}')">Excluir</button>
        </div>
      `).join('') || 'Nenhum registro de monitoramento';
    }

    async function deleteMonitoramentoEntry(username, timestamp) {
      try {
        const userRef = db.collection('usuarios').doc(username);
        const userDoc = await userRef.get();
        const monitoramento = userDoc.data().monitoramento || [];
        const updatedMonitoramento = monitoramento.filter(entry => entry.timestamp !== timestamp);

        await userRef.update({ monitoramento: updatedMonitoramento });
        showPopup('Registro de monitoramento exclu√≠do com sucesso!');
        if (document.getElementById('userDetailScreen').style.display === 'block') {
          renderUserDetail({ ...userDoc.data(), monitoramento: updatedMonitoramento });
        }
      } catch (error) {
        console.error('Erro ao excluir registro de monitoramento:', error);
        showPopup('Erro ao excluir registro de monitoramento!', true);
      }
    }

    document.getElementById('exportBtn').addEventListener('click', () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(18);
      doc.text('Caderneta Virtual do Idoso', 20, 20);
      
      const sections = document.querySelectorAll('.review-container');
      let yPosition = 30;

      sections.forEach(section => {
        const title = section.querySelector('h3').innerText;
        const content = section.querySelector('div').innerText;
        
        doc.setFontSize(14);
        doc.text(title, 20, yPosition);
        yPosition += 10;
        
        doc.setFontSize(12);
        const splitContent = doc.splitTextToSize(content, 170);
        splitContent.forEach(line => {
          doc.text(line, 20, yPosition);
          yPosition += 7;
        });
        yPosition += 10;
      });

      doc.save('caderneta-idoso.pdf');
    });

    document.getElementById('monitoramentoBtn').addEventListener('click', () => {
      document.getElementById('monitoramentoOverlay').style.display = 'block';
      document.getElementById('monitoramentoScreen').style.display = 'block';
    });

    document.getElementById('closeMonitorBtn').addEventListener('click', () => {
      document.getElementById('monitoramentoOverlay').style.display = 'none';
      document.getElementById('monitoramentoScreen').style.display = 'none';
    });

    document.getElementById('saveMonitorBtn').addEventListener('click', async () => {
      const pa = document.getElementById('paMonitor').value;
      const glicemia = document.getElementById('glicemiaMonitor').value;
      
      const username = localStorage.getItem('currentUser');
      if(!username) return;

      try {
        const userRef = db.collection('usuarios').doc(username);
        await userRef.update({
          monitoramento: firebase.firestore.FieldValue.arrayUnion({
            pa: pa,
            glicemia: glicemia,
            timestamp: new Date().toISOString()
          })
        });
        
        const data = await loadUserData(username);
        updateReviewScreen(data);
        showPopup('Monitoramento salvo!');
        
        document.getElementById('monitoramentoOverlay').style.display = 'none';
        document.getElementById('monitoramentoScreen').style.display = 'none';
      } catch (error) {
        console.error('Erro ao salvar monitoramento:', error);
        showPopup('Erro ao salvar monitoramento!', true);
      }
    });

    document.getElementById('medicalAccessBtn').addEventListener('click', () => {
      document.getElementById('reviewScreen').style.display = 'none';
      document.getElementById('medicalLoginScreen').style.display = 'block';
    });

    document.getElementById('medBackBtn').addEventListener('click', () => {
      document.getElementById('medicalLoginScreen').style.display = 'none';
      document.getElementById('reviewScreen').style.display = 'block';
    });

    document.getElementById('medLoginBtn').addEventListener('click', () => {
      const username = document.getElementById('medUsername').value;
      const password = document.getElementById('medPassword').value;
      
      if(username === 'admin' && password === 'admin123') {
        document.getElementById('medicalLoginScreen').style.display = 'none';
        loadMedicalAccess();
      } else {
        alert('Credenciais inv√°lidas!');
      }
    });

    async function loadMedicalAccess() {
      document.getElementById('medicalAccessScreen').style.display = 'block';
      
      if (medicalAccessUnsubscribe) {
        medicalAccessUnsubscribe();
      }
      
      medicalAccessUnsubscribe = db.collection('usuarios').onSnapshot(snapshot => {
        const users = [];
        snapshot.forEach(doc => {
          const userData = doc.data();
          users.push({ 
            id: doc.id,
            nome: userData.identificacao.nome,
            dataNascimento: userData.identificacao.dataNascimento
          });
        });
        
        users.sort((a, b) => a.nome.localeCompare(b.nome));
        
        displayUsers(users);
        
        const searchInput = document.getElementById('userSearch');
        searchInput.oninput = (e) => {
          const term = e.target.value.toLowerCase();
          const filtered = users.filter(user => 
            user.nome.toLowerCase().includes(term) ||
            user.id.toLowerCase().includes(term) ||
            user.dataNascimento.includes(term)
          );
          displayUsers(filtered);
        };
      }, error => {
        console.error('Erro na escuta em tempo real:', error);
        showPopup('Erro ao carregar pacientes!', true);
      });
    }

    function displayUsers(users) {
      const userList = document.getElementById('userList');
      
      if (users.length === 0) {
        userList.innerHTML = '<p class="no-users">Nenhum paciente encontrado</p>';
        return;
      }
      
      userList.innerHTML = users.map(user => `
        <div class="user-item" onclick="showUserDetail('${user.id}')">
          <div class="user-name">${user.nome}</div>
          <div class="user-details">
            <span class="user-id">ID: ${user.id}</span>
            <span class="user-birth">Nasc: ${user.dataNascimento}</span>
          </div>
        </div>
      `).join('');
    }

    async function showUserDetail(userId) {
      currentEditingUser = userId;
      if(userDetailUnsubscribe) userDetailUnsubscribe();
      
      try {
        const doc = await db.collection('usuarios').doc(userId).get();
        if(doc.exists) {
          currentUserData = doc.data();
          renderUserDetail(currentUserData);
          document.getElementById('medicalAccessScreen').style.display = 'none';
          document.getElementById('userDetailScreen').style.display = 'block';
          
          userDetailUnsubscribe = db.collection('usuarios').doc(userId).onSnapshot(doc => {
            if(doc.exists) {
              currentUserData = doc.data();
              renderUserDetail(currentUserData);
            }
          });
          
          // Carrega os exames do paciente
          loadUserExames(userId);
        }
      } catch (error) {
        console.error('Erro ao carregar detalhes:', error);
        showPopup('Erro ao carregar dados do paciente!', true);
      }
    }

    function renderUserDetail(userData) {
      const detailContent = document.getElementById('userDetailContent');
      detailContent.innerHTML = `
        <div class="detail-tab-content active" id="detail-identificacao">
          <div class="compact-form">
            <div class="form-row">
              <label>Nome:</label>
              ${isEditing ? 
                `<input type="text" class="edit-input" data-field="identificacao.nome" value="${userData.identificacao.nome}">` : 
                `<span>${userData.identificacao.nome}</span>`
              }
            </div>
            <div class="form-row">
              <label>Nascimento:</label>
              ${isEditing ? 
                `<input type="date" class="edit-input" data-field="identificacao.dataNascimento" value="${userData.identificacao.dataNascimento}">` : 
                `<span>${userData.identificacao.dataNascimento}</span>`
              }
            </div>
            <div class="form-row">
              <label>Contato:</label>
              ${isEditing ? 
                `<input type="tel" class="edit-input" data-field="identificacao.contato" value="${userData.identificacao.contato}">` : 
                `<span>${userData.identificacao.contato}</span>`
              }
            </div>
            <div class="form-row">
              <label>Peso:</label>
              ${isEditing ? 
                `<input type="number" class="edit-input" data-field="identificacao.peso" value="${userData.identificacao.peso}">` : 
                `<span>${userData.identificacao.peso}</span>`
              }
            </div>
          </div>
        </div>

        <div class="detail-tab-content" id="detail-vacinacao">
          ${userData.vacinacao.map((vacina, index) => `
            <div class="vacina-form" data-index="${index}">
              <div class="form-row">
                <label>Vacina:</label>
                ${isEditing ? 
                  `<input type="text" class="edit-input" data-field="vacinacao[${index}].nomeVacina" value="${vacina.nomeVacina}">` : 
                  `<span>${vacina.nomeVacina}</span>`
                }
              </div>
              <div class="form-row">
                <label>Data:</label>
                ${isEditing ? 
                  `<input type="date" class="edit-input" data-field="vacinacao[${index}].dataAplicacao" value="${vacina.dataAplicacao}">` : 
                  `<span>${vacina.dataAplicacao}</span>`
                }
              </div>
              <div class="form-row">
                <label>Lote:</label>
                ${isEditing ? 
                  `<input type="text" class="edit-input" data-field="vacinacao[${index}].loteVacina" value="${vacina.loteVacina}">` : 
                  `<span>${vacina.loteVacina}</span>`
                }
              </div>
              <div class="form-row">
                <label>Observa√ß√µes:</label>
                ${isEditing ? 
                  `<textarea class="edit-input" data-field="vacinacao[${index}].observacoes">${vacina.observacoes}</textarea>` : 
                  `<span>${vacina.observacoes}</span>`
                }
              </div>
              ${isEditing ? `<button class="delete-btn" onclick="this.closest('.vacina-form').remove()">Excluir</button>` : ''}
            </div>
          `).join('')}
          ${isEditing ? `<button class="btn add-item-btn" onclick="addNewVacina()">+ Nova Vacina</button>` : ''}
        </div>

        <div class="detail-tab-content" id="detail-doencas">
          <div class="compact-form">
            <div class="form-row">
              <label>Hipertens√£o:</label>
              <input type="checkbox" ${userData.doencas.hipertensao ? 'checked' : ''} 
                ${isEditing ? 'data-field="doencas.hipertensao"' : 'disabled'}>
            </div>
            <div class="form-row">
              <label>Diabetes:</label>
              <input type="checkbox" ${userData.doencas.diabetes ? 'checked' : ''} 
                ${isEditing ? 'data-field="doencas.diabetes"' : 'disabled'}>
            </div>
            <div class="form-row">
              <label>Cardiopatias:</label>
              <input type="checkbox" ${userData.doencas.cardiopatias ? 'checked' : ''} 
                ${isEditing ? 'data-field="doencas.cardiopatias"' : 'disabled'}>
            </div>
            <div class="form-row">
              <label>Chagas:</label>
              <input type="checkbox" ${userData.doencas.chagas ? 'checked' : ''} 
                ${isEditing ? 'data-field="doencas.chagas"' : 'disabled'}>
            </div>
            <div class="form-row">
              <label>Outras:</label>
              ${isEditing ? 
                `<input type="text" class="edit-input" data-field="doencas.outras" value="${userData.doencas.outras || ''}">` : 
                `<span>${userData.doencas.outras || 'Nenhuma'}</span>`
              }
            </div>
          </div>
        </div>

        <div class="detail-tab-content" id="detail-medicamentos">
          ${userData.medicamentos.map((med, index) => `
            <div class="medicamento-form" data-index="${index}">
              <div class="form-row">
                <label>Medicamento:</label>
                ${isEditing ? 
                  `<input type="text" class="edit-input" data-field="medicamentos[${index}].nome" value="${med.nome}">` : 
                  `<span>${med.nome}</span>`
                }
              </div>
              <div class="form-row">
                <label>Dose:</label>
                ${isEditing ? 
                  `<input type="text" class="edit-input" data-field="medicamentos[${index}].dose" value="${med.dose}">` : 
                  `<span>${med.dose}</span>`
                }
              </div>
              <div class="form-row">
                <label>Posologia:</label>
                ${isEditing ? 
                  `<input type="text" class="edit-input" data-field="medicamentos[${index}].posologia" value="${med.posologia}">` : 
                  `<span>${med.posologia}</span>`
                }
              </div>
              <div class="form-row">
                <label>Hor√°rio:</label>
                ${isEditing ? 
                  `<input type="time" class="edit-input" data-field="medicamentos[${index}].horario" value="${med.horario}">` : 
                  `<span>${med.horario}</span>`
                }
              </div>
              ${isEditing ? `<button class="delete-btn" onclick="this.closest('.medicamento-form').remove()">Excluir</button>` : ''}
            </div>
          `).join('')}
          ${isEditing ? `<button class="btn add-item-btn" onclick="addNewMedicamento()">+ Novo Medicamento</button>` : ''}
        </div>

        <div class="detail-tab-content" id="detail-anotacoes">
          <div class="form-row">
            ${isEditing ? 
              `<textarea class="edit-input" data-field="anotacoes">${userData.anotacoes || ''}</textarea>` : 
              `<span>${userData.anotacoes || 'Nenhuma anota√ß√£o'}</span>`
            }
          </div>
        </div>

        <div class="detail-tab-content" id="detail-monitoramento">
          ${(userData.monitoramento || []).map((entry, index) => `
            <div class="monitoramento-item">
              <div>
                <strong>PA:</strong> ${entry.pa}<br>
                <strong>Glicemia:</strong> ${entry.glicemia}<br>
                <em>${new Date(entry.timestamp).toLocaleString()}</em>
              </div>
              <button class="delete-monitoramento-btn" onclick="deleteMonitoramentoEntry('${currentEditingUser}', '${entry.timestamp}')">
                Excluir
              </button>
            </div>
          `).join('')}
        </div>
      `;

      document.querySelectorAll('.detail-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.detail-tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.detail-tab-content').forEach(c => c.classList.remove('active'));
          tab.classList.add('active');
          const targetTab = tab.dataset.tab;
          document.getElementById(targetTab).classList.add('active');
          currentDetailTab = targetTab;
        });
      });

      const activeTab = document.querySelector(`.detail-tab[data-tab="${currentDetailTab}"]`);
      if(activeTab) {
        activeTab.classList.add('active');
        document.getElementById(currentDetailTab).classList.add('active');
      }
    }

    function addNewMedicamento() {
      const container = document.querySelector('#detail-medicamentos');
      const newIndex = container.querySelectorAll('.medicamento-form').length;
      
      const newMed = document.createElement('div');
      newMed.className = 'medicamento-form';
      newMed.innerHTML = `
        <div class="form-row">
          <label>Medicamento:</label>
          <input type="text" class="edit-input" data-field="medicamentos[${newIndex}].nome">
        </div>
        <div class="form-row">
          <label>Dose:</label>
          <input type="text" class="edit-input" data-field="medicamentos[${newIndex}].dose">
        </div>
        <div class="form-row">
          <label>Posologia:</label>
          <input type="text" class="edit-input" data-field="medicamentos[${newIndex}].posologia">
        </div>
        <div class="form-row">
          <label>Hor√°rio:</label>
          <input type="time" class="edit-input" data-field="medicamentos[${newIndex}].horario">
        </div>
        <button class="delete-btn" onclick="this.closest('.medicamento-form').remove()">Excluir</button>
      `;
      container.insertBefore(newMed, container.lastElementChild);
    }

    function addNewVacina() {
      const container = document.querySelector('#detail-vacinacao');
      const newIndex = container.querySelectorAll('.vacina-form').length;
      
      const newVac = document.createElement('div');
      newVac.className = 'vacina-form';
      newVac.innerHTML = `
        <div class="form-row">
          <label>Vacina:</label>
          <input type="text" class="edit-input" data-field="vacinacao[${newIndex}].nomeVacina">
        </div>
        <div class="form-row">
          <label>Data:</label>
          <input type="date" class="edit-input" data-field="vacinacao[${newIndex}].dataAplicacao">
        </div>
        <div class="form-row">
          <label>Lote:</label>
          <input type="text" class="edit-input" data-field="vacinacao[${newIndex}].loteVacina">
        </div>
        <div class="form-row">
          <label>Observa√ß√µes:</label>
          <textarea class="edit-input" data-field="vacinacao[${newIndex}].observacoes"></textarea>
        </div>
        <button class="delete-btn" onclick="this.closest('.vacina-form').remove()">Excluir</button>
      `;
      container.insertBefore(newVac, container.lastElementChild);
    }

    function toggleEditMode() {
      isEditing = !isEditing;
      document.getElementById('editUserBtn').style.display = isEditing ? 'none' : 'block';
      document.getElementById('saveUserBtn').style.display = isEditing ? 'block' : 'none';
      renderUserDetail(currentUserData);
    }

    async function saveUserChanges() {
      try {
        const userRef = db.collection('usuarios').doc(currentEditingUser);
        const updatedData = { ...currentUserData };

        updatedData.identificacao = {
          nome: document.querySelector('[data-field="identificacao.nome"]')?.value || '',
          dataNascimento: document.querySelector('[data-field="identificacao.dataNascimento"]')?.value || '',
          contato: document.querySelector('[data-field="identificacao.contato"]')?.value || '',
          peso: document.querySelector('[data-field="identificacao.peso"]')?.value || '',
          contatoEmergencia: document.querySelector('[data-field="identificacao.contatoEmergencia"]')?.value || ''
        };

        updatedData.doencas = {
          hipertensao: document.querySelector('[data-field="doencas.hipertensao"]')?.checked || false,
          diabetes: document.querySelector('[data-field="doencas.diabetes"]')?.checked || false,
          cardiopatias: document.querySelector('[data-field="doencas.cardiopatias"]')?.checked || false,
          chagas: document.querySelector('[data-field="doencas.chagas"]')?.checked || false,
          outras: document.querySelector('[data-field="doencas.outras"]')?.value || ''
        };

        updatedData.vacinacao = Array.from(document.querySelectorAll('#detail-vacinacao .vacina-form')).map(form => ({
          nomeVacina: form.querySelector('[data-field$=".nomeVacina"]')?.value || '',
          dataAplicacao: form.querySelector('[data-field$=".dataAplicacao"]')?.value || '',
          loteVacina: form.querySelector('[data-field$=".loteVacina"]')?.value || '',
          observacoes: form.querySelector('[data-field$=".observacoes"]')?.value || ''
        }));

        updatedData.medicamentos = Array.from(document.querySelectorAll('#detail-medicamentos .medicamento-form')).map(form => ({
          nome: form.querySelector('[data-field$=".nome"]')?.value || '',
          dose: form.querySelector('[data-field$=".dose"]')?.value || '',
          posologia: form.querySelector('[data-field$=".posologia"]')?.value || '',
          horario: form.querySelector('[data-field$=".horario"]')?.value || ''
        }));

        updatedData.anotacoes = document.querySelector('[data-field="anotacoes"]')?.value || '';

        await userRef.set(updatedData, { merge: true });
        
        currentUserData = updatedData;
        renderUserDetail(currentUserData);
        showPopup('Altera√ß√µes salvas com sucesso!');
        toggleEditMode();
      } catch (error) {
        console.error('Erro ao salvar altera√ß√µes:', error);
        showPopup('Erro ao salvar altera√ß√µes!', true);
      }
    }

    async function deleteUser() {
      if(confirm('Tem certeza que deseja excluir este usu√°rio permanentemente?')) {
        try {
          // Primeiro deleta todos os exames do usu√°rio
          const examesRef = db.collection('usuarios').doc(currentEditingUser).collection('exames');
          const snapshot = await examesRef.get();
          
          const batch = db.batch();
          snapshot.forEach(doc => {
            batch.delete(doc.ref);
          });
          await batch.commit();
          
          // Depois deleta os arquivos no Storage
          const listResult = await storage.ref(`exames/${currentEditingUser}`).listAll();
          await Promise.all(listResult.items.map(item => item.delete()));
          
          // Finalmente deleta o usu√°rio
          await db.collection('usuarios').doc(currentEditingUser).delete();
          
          showPopup('Usu√°rio exclu√≠do com sucesso!');
          closeUserDetail();
          loadMedicalAccess();
        } catch (error) {
          console.error('Erro ao excluir usu√°rio:', error);
          showPopup('Erro ao excluir usu√°rio!', true);
        }
      }
    }

    function closeUserDetail() {
      if(userDetailUnsubscribe) userDetailUnsubscribe();
      document.getElementById('userDetailScreen').style.display = 'none';
      document.getElementById('medicalAccessScreen').style.display = 'block';
    }

    document.getElementById('medLogoutBtn').addEventListener('click', () => {
      if (medicalAccessUnsubscribe) {
        medicalAccessUnsubscribe();
        medicalAccessUnsubscribe = null;
      }
      document.getElementById('medicalAccessScreen').style.display = 'none';
      document.getElementById('reviewScreen').style.display = 'block';
    });

    document.getElementById('generateQrBtn').addEventListener('click', () => {
      document.getElementById('medicalAccessScreen').style.display = 'none';
      document.getElementById('qrCodeScreen').style.display = 'block';
    });

    document.getElementById('closeQrBtn').addEventListener('click', () => {
      document.getElementById('qrCodeScreen').style.display = 'none';
      document.getElementById('medicalAccessScreen').style.display = 'block';
    });

    document.getElementById('generateQrCodeBtn').addEventListener('click', async () => {
      const nome = document.getElementById('qrNome').value;
      const dataNascimento = document.getElementById('qrNascimento').value;
      
      if(!nome || !dataNascimento) {
        alert('Por favor, preencha todos os campos obrigat√≥rios!');
        return;
      }
      
      const pacienteData = {
        nome: nome,
        dataNascimento: dataNascimento,
        timestamp: new Date().toISOString()
      };
      
      const qrData = JSON.stringify(pacienteData);
      
      QRCode.toCanvas(document.getElementById('qrCanvas'), qrData, { width: 200 }, (error) => {
        if (error) {
          console.error('Erro ao gerar QR Code:', error);
          showPopup('Erro ao gerar QR Code!', true);
        } else {
          document.getElementById('qrCodeContainer').style.display = 'block';
          showPopup('QR Code gerado com sucesso!');
        }
      });
    });

    async function setMedicationAlarm() {
      try {
        const medicamentos = currentUserData.medicamentos;
        const now = new Date();
        
        medicamentos.forEach(med => {
          if(med.horario) {
            const [hours, minutes] = med.horario.split(':');
            const alarmTime = new Date();
            alarmTime.setHours(hours);
            alarmTime.setMinutes(minutes);
            
            if(alarmTime < now) alarmTime.setDate(alarmTime.getDate() + 1);
            
            if('Notification' in window) {
              if(Notification.permission === 'granted') {
                new Notification(`Alarme: ${med.nome}`, {
                  body: `Hora de tomar ${med.dose} - ${med.posologia}`,
                  icon: 'https://i.imgur.com/BzIGz3X.png',
                  timestamp: alarmTime.getTime()
                });
              } else if(Notification.permission !== 'denied') {
                Notification.requestPermission().then(permission => {
                  if(permission === 'granted') {
                    new Notification(`Alarme: ${med.nome}`, {
                      body: `Hora de tomar ${med.dose} - ${med.posologia}`,
                      icon: 'https://i.imgur.com/BzIGz3X.png',
                      timestamp: alarmTime.getTime()
                    });
                  }
                });
              }
            }
          }
        });
        showPopup('Alarmes configurados com sucesso!');
      } catch (error) {
        console.error('Erro ao configurar alarmes:', error);
        showPopup('Erro ao configurar alarmes!', true);
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const username = localStorage.getItem('currentUser');
      if(username) {
        reviewUnsubscribe = setupRealtimeUpdates(username);
        const data = await loadUserData(username);
        if(data) {
          updateReviewScreen(data);
          document.getElementById('homeScreen').style.display = 'none';
          document.getElementById('reviewScreen').style.display = 'block';
          
          // Carrega os exames do paciente
          loadExames(username);
        }
      }
      
      // Configura os bot√µes de exames
      document.getElementById('addExamBtn').addEventListener('click', openExamModal);
      document.getElementById('takePhotoBtn').addEventListener('click', takeExamPhoto);
      document.getElementById('uploadPhotoBtn').addEventListener('click', () => {
        document.getElementById('examFileInput').click();
      });
      document.getElementById('closeExamModalBtn').addEventListener('click', closeExamModal);
      document.getElementById('examFileInput').addEventListener('change', handleFileUpload);
    });

    async function loadUserData(username) {
      try {
        const doc = await db.collection('usuarios').doc(username).get();
        if (doc.exists) {
          return doc.data();
        }
        return null;
      } catch (error) {
        console.error('Erro ao carregar dados:', error);
        return null;
      }
    }

    function showPopup(message, isError = false) {
      const popup = document.getElementById('popup');
      popup.textContent = message;
      popup.style.backgroundColor = isError ? '#dc3545' : '#3b5448';
      popup.classList.add('show');
      setTimeout(() => popup.classList.remove('show'), 3000);
    }

    document.getElementById('editBtn').addEventListener('click', async () => {
      const username = localStorage.getItem('currentUser');
      if (username) {
        const doc = await db.collection('usuarios').doc(username).get();
        if (doc.exists) {
          const data = doc.data();
          document.getElementById('nome').value = data.identificacao.nome;
          document.getElementById('dataNascimento').value = data.identificacao.dataNascimento;
          document.getElementById('peso').value = data.identificacao.peso;
          document.getElementById('contato').value = data.identificacao.contato;
          document.getElementById('contatoEmergencia').value = data.identificacao.contatoEmergencia;
          document.getElementById('anotacoes').value = data.anotacoes;
          
          document.getElementById('reviewScreen').style.display = 'none';
          document.getElementById('editScreen').style.display = 'block';
        }
      }
    });

    document.getElementById('deleteAllBtn').addEventListener('click', async function() {
      if(confirm('Tem certeza que deseja excluir TODOS os dados permanentemente?\nEsta a√ß√£o n√£o pode ser desfeita!')) {
        try {
          const username = localStorage.getItem('currentUser');
          if (!username) {
            showPopup('Nenhum usu√°rio encontrado para excluir!', true);
            return;
          }
          
          // Primeiro deleta todos os exames
          const examesRef = db.collection('usuarios').doc(username).collection('exames');
          const snapshot = await examesRef.get();
          
          const batch = db.batch();
          snapshot.forEach(doc => {
            batch.delete(doc.ref);
          });
          await batch.commit();
          
          // Depois deleta os arquivos no Storage
          const listResult = await storage.ref(`exames/${username}`).listAll();
          await Promise.all(listResult.items.map(item => item.delete()));
          
          // Finalmente deleta o usu√°rio
          await db.collection('usuarios').doc(username).delete();
          
          // Limpa o localStorage e redireciona para a tela inicial
          localStorage.removeItem('currentUser');
          showPopup('Todos os dados foram exclu√≠dos com sucesso!');
          
          // Esconde todas as telas e mostra apenas a tela inicial
          document.querySelectorAll('.container, #medicalLoginScreen, #medicalAccessScreen, #userDetailScreen, #qrCodeScreen').forEach(el => {
            el.style.display = 'none';
          });
          document.getElementById('homeScreen').style.display = 'block';
          
        } catch (error) {
          console.error('Erro ao excluir dados:', error);
          showPopup('Erro ao excluir dados!', true);
        }
      }
    });

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => {
            console.log('Service Worker registrado:', registration.scope);
          })
          .catch(error => {
            console.log('Falha no registro:', error);
          });
      });
    }
  </script>
</body>
</html>
