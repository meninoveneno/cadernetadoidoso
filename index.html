<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  
  <!-- Configurações PWA Atualizadas -->
  <meta name="theme-color" content="#007bff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="manifest" href="/manifest.json">
  
  <title>Caderneta Virtual do Idoso</title>
  
  <!-- Ícones PWA Atualizados -->
  <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/4441/4441163.png">
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/4441/4441163.png">
  
  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-firestore-compat.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    /* Estilos mantidos intactos conforme original */
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 16px; margin: 0; padding: 0; background-color: #f8f9fa; color: #333; }
    .container { max-width: 900px; margin: 20px auto; background: #fff; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); padding: 30px; border-radius: 12px; position: relative; }
    #homeScreen { text-align: center; padding: 50px 20px; background: linear-gradient(135deg, #007bff, #00bfff); color: #fff; border-radius: 12px; position: relative; }
    #homeScreen h1 { font-size: 36px; margin-bottom: 10px; }
    #homeScreen h2 { font-size: 24px; margin-bottom: 30px; font-weight: 400; }
    #homeScreen img { width: 73.125px; position: absolute; left: 20px; bottom: 20px; }
    #homeScreen button { padding: 12px 20px; border: none; background: #28a745; color: #fff; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: background-color 0.3s; }
    #homeScreen button:hover { background-color: #218838; }
    .tabs { display: flex; overflow-x: auto; padding: 0; list-style: none; border-bottom: 2px solid #e9ecef; margin-bottom: 20px; }
    .tabs li { text-align: center; padding: 12px 20px; font-size: 16px; font-weight: 600; cursor: pointer; background-color: #e9ecef; border-radius: 8px 8px 0 0; transition: all 0.3s ease; flex-shrink: 0; min-width: 120px; margin-right: 8px; color: #495057; }
    .tabs li.active { background-color: #007bff; color: white; box-shadow: 0 4px 6px rgba(0, 123, 255, 0.2); }
    .tabs li:hover { background-color: #0056b3; color: white; }
    .tab-content { display: none; animation: fadeIn 0.5s ease-in-out; }
    .tab-content.active { display: block; }
    form label { display: block; margin-top: 12px; font-size: 16px; font-weight: 600; color: #495057; }
    form input, form select, form textarea { width: 100%; padding: 10px; margin-top: 8px; border: 1px solid #ced4da; border-radius: 8px; font-size: 16px; transition: border-color 0.3s ease; }
    form input:focus, form select:focus, form textarea:focus { border-color: #007bff; outline: none; box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1); }
    form textarea { resize: vertical; min-height: 100px; }
    .btn { margin-top: 20px; padding: 12px 20px; border: none; background: #28a745; color: #fff; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: background-color 0.3s; width: 100%; max-width: 200px; }
    .btn:hover { background-color: #218838; }
    #addMedicamento, #addVacina { background: #17a2b8; width: 100%; max-width: 200px; }
    #addMedicamento:hover, #addVacina:hover { background: #117a8b; }
    #monitoramentoBtn { background-color: #ffc107; color: #333; }
    #monitoramentoBtn:hover { background-color: #e0a800; }
    .popup { position: fixed; top: 20px; right: 20px; background: #28a745; color: #fff; padding: 12px 20px; border-radius: 8px; font-size: 16px; opacity: 0; transition: opacity 0.5s; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
    .popup.show { opacity: 1; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @media(max-width: 600px) {
      .tabs li { font-size: 14px; padding: 10px 15px; min-width: 100px; }
      button, form input, form select, form textarea { font-size: 14px; padding: 8px; }
      form label { font-size: 14px; }
      .review-buttons { flex-direction: column; gap: 10px; }
      .review-buttons .btn { max-width: 100%; width: 100%; }
    }
    .review-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
    #monitoramentoOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: none; z-index: 900; }
    #monitoramentoScreen { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 20px; border-radius: 12px; z-index: 1000; display: none; width: 90%; max-width: 400px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
    #monitoramentoScreen h3 { margin-top: 0; color: #333; }
    #monitoramentoScreen button { margin-top: 10px; width: 48%; }
    .vacina-form, .medicamento-form { border: 1px solid #e9ecef; padding: 15px; margin-bottom: 15px; border-radius: 8px; background-color: #f8f9fa; }
    .vacina-form .form-row, .medicamento-form .form-row { display: flex; gap: 10px; margin-bottom: 10px; }
    .vacina-form .form-row label, .medicamento-form .form-row label { flex: 1; }
    .vacina-form .form-row input, .vacina-form .form-row textarea, .medicamento-form .form-row input, .medicamento-form .form-row textarea { flex: 2; }
    .delete-btn { background-color: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 14px; margin-top: 10px; transition: background-color 0.3s; }
    .delete-btn:hover { background-color: #c82333; }
    .review-container { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1); }
    .review-container h3 { margin-top: 0; color: #007bff; }
    .alarm-btn { background-color: #ffc107; color: #333; display: flex; align-items: center; gap: 8px; padding: 10px 15px; border-radius: 8px; cursor: pointer; transition: background-color 0.3s; }
    .alarm-btn:hover { background-color: #e0a800; }
    .alarm-btn i { font-size: 18px; }

    /* Novos estilos para acesso médico - MODIFICADO */
    #medicalLoginScreen, #medicalAccessScreen, #userDetailScreen {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .medical-search {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .user-list {
      max-height: 400px;
      overflow-y: auto;
      margin: 15px 0;
    }
    .user-item {
      padding: 12px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background 0.2s;
    }
    .user-item:hover {
      background-color: #f8f9fa;
    }
    .medical-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }
    #userDetailContent {
      max-height: 60vh;
      overflow-y: auto;
      padding: 15px;
      border: 1px solid #eee;
      border-radius: 8px;
      margin: 15px 0;
    }
    .editable-field {
      border: 1px solid transparent;
      padding: 5px;
      margin: 5px 0;
      transition: all 0.3s;
    }
    .editable-field.editing {
      border-color: #007bff;
      background-color: #f8f9fa;
    }
    .edit-input {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .btn-danger {
      background-color: #dc3545;
    }
    .btn-danger:hover {
      background-color: #c82333;
    }
  </style>

  <!-- Firebase Configuration -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCMP_bBotEMngO0pLkxhrZvvgCJqIFTZCY",
      authDomain: "cadernetavirtualdoidoso.firebaseapp.com",
      projectId: "cadernetavirtualdoidoso",
      storageBucket: "cadernetavirtualdoidoso.appspot.com",
      messagingSenderId: "374078415962",
      appId: "1:374078415962:web:8d8566388ee8336f986463"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>
</head>
<body>
  <div id="homeScreen" class="container">
    <h1>Caderneta Virtual do Idoso</h1>
    <h2>Cuidar hoje para viver melhor amanhã! - Grupo D Inovação e Tecnologia em Saúde FUNORTE 2025.1</h2>
    <img src="https://cdn-icons-png.flaticon.com/512/4441/4441163.png" alt="Logo">
    <button id="startBtn">Iniciar</button>
  </div>

  <div id="editScreen" class="container" style="display: none;">
    <ul class="tabs">
      <li class="tab active" data-tab="identificacao">Identificação</li>
      <li class="tab" data-tab="vacinacao">Vacinação</li>
      <li class="tab" data-tab="doencas">Doenças Crônicas</li>
      <li class="tab" data-tab="medicamentos">Medicamentos</li>
      <li class="tab" data-tab="recomendacoes">Anotações</li>
    </ul>

    <div class="tab-content active" id="identificacao">
      <form id="form-identificacao">
        <label for="nome">Nome:</label>
        <input type="text" id="nome" name="nome">
        <label for="dataNascimento">Data de Nascimento:</label>
        <input type="date" id="dataNascimento" name="dataNascimento">
        <label for="peso">Peso (kg):</label>
        <input type="number" id="peso" name="peso">
        <label for="contato">Contato:</label>
        <input type="tel" id="contato" name="contato">
        <label for="contatoEmergencia">Contato de Emergência:</label>
        <input type="tel" id="contatoEmergencia" name="contatoEmergencia">
      </form>
    </div>

    <div class="tab-content" id="vacinacao">
      <div id="vacinasContainer">
        <div class="vacina-form">
          <div class="form-row">
            <label for="nomeVacina">Nome da Vacina:</label>
            <input type="text" class="nomeVacina" name="nomeVacina[]">
          </div>
          <div class="form-row">
            <label for="dataAplicacao">Data de Aplicação:</label>
            <input type="date" class="dataAplicacao" name="dataAplicacao[]">
          </div>
          <div class="form-row">
            <label for="loteVacina">Lote:</label>
            <input type="text" class="loteVacina" name="loteVacina[]">
          </div>
          <div class="form-row">
            <label for="observacoesVacina">Observações:</label>
            <textarea class="observacoesVacina" name="observacoesVacina[]"></textarea>
          </div>
          <button type="button" class="delete-btn" onclick="deleteVacinaForm(this)">Excluir Vacina</button>
        </div>
      </div>
      <button type="button" id="addVacina" class="btn">Adicionar Vacina</button>
    </div>

    <div class="tab-content" id="doencas">
      <form id="form-doencas">
        <label><input type="checkbox" id="hipertensao" name="hipertensao"> Hipertensão</label>
        <label><input type="checkbox" id="diabetes" name="diabetes"> Diabetes</label>
        <label><input type="checkbox" id="cardiopatias" name="cardiopatias"> Cardiopatias</label>
        <label><input type="checkbox" id="chagas" name="chagas"> Chagas</label>
        <label for="outrasDoencas">Outras Doenças/Alergias:</label>
        <input type="text" id="outrasDoencas" name="outrasDoencas">
      </form>
    </div>

    <div class="tab-content" id="medicamentos">
      <form id="form-medicamentos">
        <div id="medicamentosContainer">
          <div class="medicamento-form">
            <label>Nome do Medicamento:</label>
            <input type="text" name="nomeMedicamento[]">
            <label>Dose:</label>
            <input type="text" name="doseMedicamento[]">
            <label>Posologia:</label>
            <input type="text" name="posologiaMedicamento[]">
            <label>Horário:</label>
            <input type="time" name="horarioMedicamento[]">
            <button type="button" class="delete-btn" onclick="deleteMedicamentoForm(this)">Excluir Medicamento</button>
          </div>
        </div>
        <button type="button" id="addMedicamento" class="btn">Adicionar Medicamento</button>
      </form>
    </div>

    <div class="tab-content" id="recomendacoes">
      <form id="form-recomendacoes">
        <label for="anotacoes">Anotações Médicas:</label>
        <textarea id="anotacoes" name="anotacoes"></textarea>
      </form>
    </div>

    <button id="saveBtn" class="btn">Salvar Dados</button>
    <div id="popup" class="popup">Dados salvos com sucesso!</div>
  </div>

  <div id="reviewScreen" class="container" style="display: none;">
    <h2>Dados do Idoso</h2>
    <div class="review-container">
      <h3>Identificação</h3>
      <div id="reviewIdentificacao"></div>
    </div>
    <div class="review-container">
      <h3>Vacinação</h3>
      <div id="reviewVacinacao"></div>
    </div>
    <div class="review-container">
      <h3>Doenças Crônicas e Alergias</h3>
      <div id="reviewDoencas"></div>
    </div>
    <div class="review-container">
      <h3>Medicamentos em Uso</h3>
      <div id="reviewMedicamentos"></div>
      <button class="alarm-btn" onclick="setMedicationAlarm()">
        <i class="fas fa-clock"></i>
        Definir alarme para medicações
      </button>
    </div>
    <div class="review-container">
      <h3>Mapeamento de PA e Glicemia</h3>
      <div id="reviewMonitoramento"></div>
    </div>
    <div class="review-container">
      <h3>Recomendações/Anotações Médicas</h3>
      <div id="reviewAnotacoes"></div>
    </div>
    <div class="review-buttons">
      <button id="exportBtn" class="btn">Exportar</button>
      <button id="monitoramentoBtn" class="btn">Monitoramento</button>
      <button id="medicalAccessBtn" class="btn">Acesso Médico</button>
      <button id="editBtn" class="btn">Editar</button>
      <button id="deleteAllBtn" class="btn">Excluir todos os dados</button>
    </div>
  </div>

  <!-- Telas de acesso médico -->
  <div id="medicalLoginScreen">
    <h2>Acesso Médico</h2>
    <input type="text" id="medUsername" placeholder="Usuário" class="medical-search">
    <input type="password" id="medPassword" placeholder="Senha" class="medical-search">
    <div class="medical-buttons">
      <button id="medLoginBtn" class="btn">Entrar</button>
      <button id="medBackBtn" class="btn">Voltar</button>
    </div>
  </div>

  <div id="medicalAccessScreen">
    <h2>Acesso Médico</h2>
    <input type="text" id="userSearch" placeholder="Pesquisar usuários..." class="medical-search">
    <div class="user-list" id="userList"></div>
    <div class="medical-buttons">
      <button id="medLogoutBtn" class="btn">Sair</button>
    </div>
  </div>

  <div id="userDetailScreen">
    <h2>Detalhes do Paciente</h2>
    <div id="userDetailContent"></div>
    <div class="medical-buttons">
      <button id="editUserBtn" class="btn" onclick="toggleEditMode()">Editar</button>
      <button id="saveUserBtn" class="btn" style="display: none;" onclick="saveUserChanges()">Salvar</button>
      <button class="btn btn-danger" onclick="deleteUser()">Excluir Usuário</button>
      <button onclick="closeUserDetail()" class="btn">Voltar</button>
    </div>
  </div>

  <div id="monitoramentoOverlay"></div>
  <div id="monitoramentoScreen">
    <h3>Mapeamento de PA e Glicemia</h3>
    <form id="form-monitoramento">
      <label for="paMonitor">Pressão Arterial (PA):</label>
      <input type="text" id="paMonitor" name="paMonitor" placeholder="ex: 120/80">
      <label for="glicemiaMonitor">Glicemia:</label>
      <input type="number" id="glicemiaMonitor" name="glicemiaMonitor">
      <div style="display: flex; justify-content: space-between;">
        <button type="button" id="saveMonitorBtn" class="btn">Salvar Monitoramento</button>
        <button type="button" id="closeMonitorBtn" class="btn">Fechar</button>
      </div>
    </form>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // Firebase Functions - MODIFICADO
    function generateUsername(nome, dataNascimento) {
      const normalized = nome.toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
        .replace(/\s+/g, '')  // Remove todos os espaços
        .replace(/[^a-z0-9]/g, '');
      const cleanDate = dataNascimento.replace(/-/g, '');
      return normalized + cleanDate;
    }

    document.getElementById('saveBtn').addEventListener('click', async () => {
      const nome = document.getElementById('nome').value;
      const dataNascimento = document.getElementById('dataNascimento').value;
      
      if(!nome || !dataNascimento) {
        alert('Nome e data de nascimento são obrigatórios!');
        return;
      }

      const username = generateUsername(nome, dataNascimento);
      
      const formData = {
        identificacao: {
          nome: nome,
          dataNascimento: dataNascimento,
          peso: document.getElementById('peso').value,
          contato: document.getElementById('contato').value,
          contatoEmergencia: document.getElementById('contatoEmergencia').value
        },
        vacinacao: Array.from(document.querySelectorAll('.vacina-form')).map(form => ({
          nomeVacina: form.querySelector('.nomeVacina').value,
          dataAplicacao: form.querySelector('.dataAplicacao').value,
          loteVacina: form.querySelector('.loteVacina').value,
          observacoes: form.querySelector('.observacoesVacina').value
        })),
        doencas: {
          hipertensao: document.getElementById('hipertensao').checked,
          diabetes: document.getElementById('diabetes').checked,
          cardiopatias: document.getElementById('cardiopatias').checked,
          chagas: document.getElementById('chagas').checked,
          outras: document.getElementById('outrasDoencas').value
        },
        medicamentos: Array.from(document.querySelectorAll('.medicamento-form')).map(form => ({
          nome: form.querySelector('input[name="nomeMedicamento[]"]').value,
          dose: form.querySelector('input[name="doseMedicamento[]"]').value,
          posologia: form.querySelector('input[name="posologiaMedicamento[]"]').value,
          horario: form.querySelector('input[name="horarioMedicamento[]"]').value
        })),
        anotacoes: document.getElementById('anotacoes').value,
        monitoramento: []
      };

      try {
        await db.collection('usuarios').doc(username).set(formData);
        localStorage.setItem('currentUser', username);
        
        updateReviewScreen(formData);
        document.getElementById('editScreen').style.display = 'none';
        document.getElementById('reviewScreen').style.display = 'block';
        
        showPopup('Dados salvos com sucesso!');
      } catch (error) {
        console.error('Erro ao salvar dados:', error);
        showPopup('Erro ao salvar dados!', true);
      }
    });

    async function loadUserData(username) {
      try {
        const doc = await db.collection('usuarios').doc(username).get();
        if (doc.exists) {
          return doc.data();
        }
        return null;
      } catch (error) {
        console.error('Erro ao carregar dados:', error);
        return null;
      }
    }

    document.getElementById('deleteAllBtn').addEventListener('click', async () => {
      if(confirm('Tem certeza que deseja excluir TODOS os dados permanentemente?')) {
        const username = localStorage.getItem('currentUser');
        if(username) {
          try {
            await db.collection('usuarios').doc(username).delete();
            localStorage.removeItem('currentUser');
            document.querySelectorAll('input, textarea').forEach(element => element.value = '');
            document.querySelectorAll('.review-container div').forEach(div => div.innerHTML = '');
            showPopup('Dados excluídos com sucesso!');
          } catch (error) {
            console.error('Erro ao excluir dados:', error);
            showPopup('Erro ao excluir dados!', true);
          }
        }
      }
    });

    function showPopup(message, isError = false) {
      const popup = document.getElementById('popup');
      popup.textContent = message;
      popup.style.backgroundColor = isError ? '#dc3545' : '#28a745';
      popup.classList.add('show');
      setTimeout(() => popup.classList.remove('show'), 3000);
    }

    // Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => {
            console.log('Service Worker registrado:', registration.scope);
          })
          .catch(error => {
            console.log('Falha no registro:', error);
          });
      });
    }

    // Tabs
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.getAttribute('data-tab')).classList.add('active');
      });
    });

    // Medicamentos
    document.getElementById('addMedicamento').addEventListener('click', () => {
      const container = document.getElementById('medicamentosContainer');
      const newBlock = document.createElement('div');
      newBlock.classList.add('medicamento-form');
      newBlock.innerHTML = `
        <label>Nome do Medicamento:</label>
        <input type="text" name="nomeMedicamento[]">
        <label>Dose:</label>
        <input type="text" name="doseMedicamento[]">
        <label>Posologia:</label>
        <input type="text" name="posologiaMedicamento[]">
        <label>Horário:</label>
        <input type="time" name="horarioMedicamento[]">
        <button type="button" class="delete-btn" onclick="deleteMedicamentoForm(this)">Excluir Medicamento</button>
      `;
      container.appendChild(newBlock);
    });

    function deleteMedicamentoForm(button) {
      if (confirm("Tem certeza que deseja excluir este medicamento?")) {
        const form = button.closest('.medicamento-form');
        form.remove();
      }
    }

    // Vacinas
    document.getElementById('addVacina').addEventListener('click', () => {
      const container = document.getElementById('vacinasContainer');
      const newBlock = document.createElement('div');
      newBlock.classList.add('vacina-form');
      newBlock.innerHTML = `
        <div class="form-row">
          <label for="nomeVacina">Nome da Vacina:</label>
          <input type="text" class="nomeVacina" name="nomeVacina[]">
        </div>
        <div class="form-row">
          <label for="dataAplicacao">Data de Aplicação:</label>
          <input type="date" class="dataAplicacao" name="dataAplicacao[]">
        </div>
        <div class="form-row">
          <label for="loteVacina">Lote:</label>
          <input type="text" class="loteVacina" name="loteVacina[]">
        </div>
        <div class="form-row">
          <label for="observacoesVacina">Observações:</label>
          <textarea class="observacoesVacina" name="observacoesVacina[]"></textarea>
        </div>
        <button type="button" class="delete-btn" onclick="deleteVacinaForm(this)">Excluir Vacina</button>
      `;
      container.appendChild(newBlock);
    });

    function deleteVacinaForm(button) {
      if (confirm("Tem certeza que deseja excluir esta vacina?")) {
        const form = button.closest('.vacina-form');
        form.remove();
      }
    }

    // Iniciar
    document.getElementById('startBtn').addEventListener('click', () => {
      document.getElementById('homeScreen').style.display = 'none';
      document.getElementById('editScreen').style.display = 'block';
      if (document.documentElement.requestFullscreen) {
        document.documentElement.requestFullscreen();
      }
    });

    // Atualizar tela de revisão
    function updateReviewScreen(data) {
      document.getElementById('reviewIdentificacao').innerHTML = `
        <p><strong>Nome:</strong> ${data.identificacao.nome}</p>
        <p><strong>Nascimento:</strong> ${data.identificacao.dataNascimento}</p>
        <p><strong>Peso:</strong> ${data.identificacao.peso} kg</p>
        <p><strong>Contato:</strong> ${data.identificacao.contato}</p>
        <p><strong>Emergência:</strong> ${data.identificacao.contatoEmergencia}</p>
      `;

      document.getElementById('reviewVacinacao').innerHTML = data.vacinacao.map(vacina => `
        <div class="review-item">
          <p><strong>${vacina.nomeVacina}</strong></p>
          <p>Data: ${vacina.dataAplicacao}</p>
          <p>Lote: ${vacina.loteVacina}</p>
          <p>Observações: ${vacina.observacoes}</p>
        </div>
      `).join('');

      const doencas = [];
      if(data.doencas.hipertensao) doencas.push('Hipertensão');
      if(data.doencas.diabetes) doencas.push('Diabetes');
      if(data.doencas.cardiopatias) doencas.push('Cardiopatias');
      if(data.doencas.chagas) doencas.push('Chagas');
      if(data.doencas.outras) doencas.push(data.doencas.outras);
      document.getElementById('reviewDoencas').innerHTML = doencas.join(', ') || 'Nenhuma doença registrada';

      document.getElementById('reviewMedicamentos').innerHTML = data.medicamentos.map(med => `
        <div class="review-item">
          <p><strong>${med.nome}</strong></p>
          <p>Dose: ${med.dose}</p>
          <p>Posologia: ${med.posologia}</p>
          <p>Horário: ${med.horario}</p>
        </div>
      `).join('');

      document.getElementById('reviewAnotacoes').innerHTML = data.anotacoes || 'Nenhuma anotação registrada';

      document.getElementById('reviewMonitoramento').innerHTML = data.monitoramento?.map(entry => `
        <div class="review-item">
          <p><strong>Pressão Arterial:</strong> ${entry.pa}</p>
          <p><strong>Glicemia:</strong> ${entry.glicemia} mg/dL</p>
          <p><em>Registrado em: ${new Date(entry.timestamp).toLocaleString()}</em></p>
        </div>
      `).join('') || 'Nenhum registro de monitoramento';
    }

    // Exportar PDF
    document.getElementById('exportBtn').addEventListener('click', () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(18);
      doc.text('Caderneta Virtual do Idoso', 20, 20);
      
      const sections = document.querySelectorAll('.review-container');
      let yPosition = 30;

      sections.forEach(section => {
        const title = section.querySelector('h3').innerText;
        const content = section.querySelector('div').innerText;
        
        doc.setFontSize(14);
        doc.text(title, 20, yPosition);
        yPosition += 10;
        
        doc.setFontSize(12);
        const splitContent = doc.splitTextToSize(content, 170);
        splitContent.forEach(line => {
          doc.text(line, 20, yPosition);
          yPosition += 7;
        });
        yPosition += 10;
      });

      doc.save('caderneta-idoso.pdf');
    });

    // Monitoramento
    document.getElementById('monitoramentoBtn').addEventListener('click', () => {
      document.getElementById('monitoramentoOverlay').style.display = 'block';
      document.getElementById('monitoramentoScreen').style.display = 'block';
    });

    document.getElementById('closeMonitorBtn').addEventListener('click', () => {
      document.getElementById('monitoramentoOverlay').style.display = 'none';
      document.getElementById('monitoramentoScreen').style.display = 'none';
    });

    document.getElementById('saveMonitorBtn').addEventListener('click', async () => {
      const pa = document.getElementById('paMonitor').value;
      const glicemia = document.getElementById('glicemiaMonitor').value;
      
      const username = localStorage.getItem('currentUser');
      if(!username) return;

      try {
        const userRef = db.collection('usuarios').doc(username);
        await userRef.update({
          monitoramento: firebase.firestore.FieldValue.arrayUnion({
            pa: pa,
            glicemia: glicemia,
            timestamp: new Date().toISOString()
          })
        });
        
        const data = await loadUserData(username);
        updateReviewScreen(data);
        showPopup('Monitoramento salvo!');
        
        document.getElementById('monitoramentoOverlay').style.display = 'none';
        document.getElementById('monitoramentoScreen').style.display = 'none';
      } catch (error) {
        console.error('Erro ao salvar monitoramento:', error);
        showPopup('Erro ao salvar monitoramento!', true);
      }
    });

    // Editar
    document.getElementById('editBtn').addEventListener('click', async () => {
      const username = localStorage.getItem('currentUser');
      if(username) {
        const userData = await loadUserData(username);
        if(userData) {
          // Preencher formulário de identificação
          document.getElementById('nome').value = userData.identificacao.nome;
          document.getElementById('dataNascimento').value = userData.identificacao.dataNascimento;
          document.getElementById('peso').value = userData.identificacao.peso;
          document.getElementById('contato').value = userData.identificacao.contato;
          document.getElementById('contatoEmergencia').value = userData.identificacao.contatoEmergencia;

          // Preencher doenças crônicas
          document.getElementById('hipertensao').checked = userData.doencas.hipertensao;
          document.getElementById('diabetes').checked = userData.doencas.diabetes;
          document.getElementById('cardiopatias').checked = userData.doencas.cardiopatias;
          document.getElementById('chagas').checked = userData.doencas.chagas;
          document.getElementById('outrasDoencas').value = userData.doencas.outras || '';

          // Preencher medicamentos
          const medicamentosContainer = document.getElementById('medicamentosContainer');
          medicamentosContainer.innerHTML = '';
          userData.medicamentos.forEach(med => {
            const newMed = document.createElement('div');
            newMed.classList.add('medicamento-form');
            newMed.innerHTML = `
              <label>Nome do Medicamento:</label>
              <input type="text" name="nomeMedicamento[]" value="${med.nome}">
              <label>Dose:</label>
              <input type="text" name="doseMedicamento[]" value="${med.dose}">
              <label>Posologia:</label>
              <input type="text" name="posologiaMedicamento[]" value="${med.posologia}">
              <label>Horário:</label>
              <input type="time" name="horarioMedicamento[]" value="${med.horario}">
              <button type="button" class="delete-btn" onclick="deleteMedicamentoForm(this)">Excluir Medicamento</button>
            `;
            medicamentosContainer.appendChild(newMed);
          });

          // Preencher vacinas
          const vacinasContainer = document.getElementById('vacinasContainer');
          vacinasContainer.innerHTML = '';
          userData.vacinacao.forEach(vacina => {
            const newVacina = document.createElement('div');
            newVacina.classList.add('vacina-form');
            newVacina.innerHTML = `
              <div class="form-row">
                <label>Nome da Vacina:</label>
                <input type="text" class="nomeVacina" value="${vacina.nomeVacina}">
              </div>
              <div class="form-row">
                <label>Data de Aplicação:</label>
                <input type="date" class="dataAplicacao" value="${vacina.dataAplicacao}">
              </div>
              <div class="form-row">
                <label>Lote:</label>
                <input type="text" class="loteVacina" value="${vacina.loteVacina}">
              </div>
              <div class="form-row">
                <label>Observações:</label>
                <textarea class="observacoesVacina">${vacina.observacoes}</textarea>
              </div>
              <button type="button" class="delete-btn" onclick="deleteVacinaForm(this)">Excluir Vacina</button>
            `;
            vacinasContainer.appendChild(newVacina);
          });

          // Preencher anotações
          document.getElementById('anotacoes').value = userData.anotacoes || '';
        }
      }
      document.getElementById('reviewScreen').style.display = 'none';
      document.getElementById('editScreen').style.display = 'block';
    });

    // Alarmes
    function setMedicationAlarm() {
      if (Notification.permission !== 'granted') {
        Notification.requestPermission();
      }

      const medicamentos = document.querySelectorAll('.medicamento-form');
      medicamentos.forEach(med => {
        const horario = med.querySelector('input[name="horarioMedicamento[]"]').value;
        const nome = med.querySelector('input[name="nomeMedicamento[]"]').value;
        
        if(horario && nome) {
          const [hours, minutes] = horario.split(':');
          const now = new Date();
          const alarmTime = new Date();
          alarmTime.setHours(hours);
          alarmTime.setMinutes(minutes);
          
          if(alarmTime < now) alarmTime.setDate(alarmTime.getDate() + 1);

          const timeout = alarmTime - now;
          
          setTimeout(() => {
            if(Notification.permission === 'granted') {
              new Notification('Hora da Medicação!', {
                body: `Lembrete para tomar: ${nome}`,
                icon: 'https://cdn-icons-png.flaticon.com/512/4441/4441163.png'
              });
            } else {
              alert(`Hora de tomar ${nome}!`);
            }
          }, timeout);
        }
      });
      alert('Alarmes configurados com sucesso!');
    }

    // Carregar dados ao iniciar
    document.addEventListener('DOMContentLoaded', async () => {
      const username = localStorage.getItem('currentUser');
      if(username) {
        const data = await loadUserData(username);
        if(data) {
          updateReviewScreen(data);
          document.getElementById('homeScreen').style.display = 'none';
          document.getElementById('reviewScreen').style.display = 'block';
        }
      }
    });

    // Acesso Médico - MODIFICADO
    document.getElementById('medicalAccessBtn').addEventListener('click', () => {
      document.getElementById('reviewScreen').style.display = 'none';
      document.getElementById('medicalLoginScreen').style.display = 'block';
    });

    document.getElementById('medBackBtn').addEventListener('click', () => {
      document.getElementById('medicalLoginScreen').style.display = 'none';
      document.getElementById('reviewScreen').style.display = 'block';
    });

    document.getElementById('medLoginBtn').addEventListener('click', () => {
      const username = document.getElementById('medUsername').value;
      const password = document.getElementById('medPassword').value;
      
      if(username === 'admin' && password === 'admin123') {
        document.getElementById('medicalLoginScreen').style.display = 'none';
        loadMedicalAccess();
      } else {
        alert('Credenciais inválidas!');
      }
    });

    async function loadMedicalAccess() {
      document.getElementById('medicalAccessScreen').style.display = 'block';
      const usersSnapshot = await db.collection('usuarios').get();
      const users = [];
      usersSnapshot.forEach(doc => users.push({ id: doc.id, ...doc.data() }));
      
      displayUsers(users);
      
      document.getElementById('userSearch').addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = users.filter(user => 
          user.identificacao.nome.toLowerCase().includes(term) ||
          user.id.toLowerCase().includes(term)
        );
        displayUsers(filtered);
      });
    }

    function displayUsers(users) {
      const userList = document.getElementById('userList');
      userList.innerHTML = users.map(user => `
        <div class="user-item" onclick="showUserDetail('${user.id}')">
          ${user.identificacao.nome} (${user.id})
        </div>
      `).join('');
    }

    let currentEditingUser = null;
    let isEditing = false;
    let unsubscribeUser = null;

    async function showUserDetail(userId) {
      currentEditingUser = userId;
      if(unsubscribeUser) unsubscribeUser();
      
      unsubscribeUser = db.collection('usuarios').doc(userId).onSnapshot(doc => {
        const userData = doc.data();
        renderUserDetail(userData);
        document.getElementById('medicalAccessScreen').style.display = 'none';
        document.getElementById('userDetailScreen').style.display = 'block';
      });
    }

    function renderUserDetail(userData) {
      const isMedUser = document.getElementById('medicalAccessScreen').style.display === 'block';
      
      document.getElementById('userDetailContent').innerHTML = `
        <div class="editable-field" data-field="identificacao.nome">
          <h3>Identificação Completa</h3>
          <p>Nome: ${userData.identificacao.nome}</p>
          <p>Nascimento: ${userData.identificacao.dataNascimento}</p>
          <p>Contato: ${userData.identificacao.contato}</p>
          <p>Peso: ${userData.identificacao.peso} kg</p>
          ${isMedUser ? `
            <input type="text" class="edit-input" value="${userData.identificacao.nome}" style="display: none;">
            <input type="date" class="edit-input" value="${userData.identificacao.dataNascimento}" style="display: none;">
            <input type="tel" class="edit-input" value="${userData.identificacao.contato}" style="display: none;">
            <input type="number" class="edit-input" value="${userData.identificacao.peso}" style="display: none;">
          ` : ''}
        </div>

        <div class="editable-field" data-field="vacinacao">
          <h3>Vacinação</h3>
          ${userData.vacinacao.map((vacina, index) => `
            <div data-index="${index}">
              <p><strong>${vacina.nomeVacina}</strong></p>
              <p>Data: ${vacina.dataAplicacao} - Lote: ${vacina.loteVacina}</p>
              <p>Observações: ${vacina.observacoes}</p>
              ${isMedUser ? `
                <input type="text" class="edit-input" value="${vacina.nomeVacina}" style="display: none;">
                <input type="date" class="edit-input" value="${vacina.dataAplicacao}" style="display: none;">
                <input type="text" class="edit-input" value="${vacina.loteVacina}" style="display: none;">
                <textarea class="edit-input" style="display: none;">${vacina.observacoes}</textarea>
              ` : ''}
            </div>
          `).join('')}
        </div>

        <div class="editable-field" data-field="doencas">
          <h3>Histórico Clínico</h3>
          <p>Doenças Crônicas: ${getDoencasList(userData.doencas)}</p>
          <p>Alergias: ${userData.doencas.outras || 'Nenhuma'}</p>
          ${isMedUser ? `
            <div class="edit-input" style="display: none;">
              <label><input type="checkbox" ${userData.doencas.hipertensao ? 'checked' : ''}> Hipertensão</label>
              <label><input type="checkbox" ${userData.doencas.diabetes ? 'checked' : ''}> Diabetes</label>
              <label><input type="checkbox" ${userData.doencas.cardiopatias ? 'checked' : ''}> Cardiopatias</label>
              <label><input type="checkbox" ${userData.doencas.chagas ? 'checked' : ''}> Chagas</label>
              <input type="text" value="${userData.doencas.outras || ''}" placeholder="Outras doenças/alergias">
            </div>
          ` : ''}
        </div>

        <div class="editable-field" data-field="monitoramento">
          <h3>Monitoramento</h3>
          ${userData.monitoramento?.map(entry => `
            <p>PA: ${entry.pa} - Glicemia: ${entry.glicemia} (${new Date(entry.timestamp).toLocaleDateString()})</p>
          `).join('') || 'Nenhum registro'}
        </div>

        <div class="editable-field" data-field="anotacoes">
          <h3>Anotações Médicas</h3>
          <p>${userData.anotacoes || 'Nenhuma anotação'}</p>
          ${isMedUser ? `<textarea class="edit-input" style="display: none;">${userData.anotacoes || ''}</textarea>` : ''}
        </div>

        <div class="editable-field" data-field="medicamentos">
          <h3>Medicações</h3>
          ${userData.medicamentos.map((med, index) => `
            <div data-index="${index}">
              <p><strong>${med.nome}</strong> - ${med.dose} (${med.posologia})</p>
              <p>Horário: ${med.horario}</p>
              ${isMedUser ? `
                <input type="text" class="edit-input" value="${med.nome}" style="display: none;">
                <input type="text" class="edit-input" value="${med.dose}" style="display: none;">
                <input type="text" class="edit-input" value="${med.posologia}" style="display: none;">
                <input type="time" class="edit-input" value="${med.horario}" style="display: none;">
              ` : ''}
            </div>
          `).join('')}
        </div>
      `;

      if(isEditing) toggleEditMode(true);
    }

    function getDoencasList(doencas) {
      const lista = [];
      if(doencas.hipertensao) lista.push('Hipertensão');
      if(doencas.diabetes) lista.push('Diabetes');
      if(doencas.cardiopatias) lista.push('Cardiopatias');
      if(doencas.chagas) lista.push('Chagas');
      return lista.join(', ') || 'Nenhuma';
    }

    function toggleEditMode(forceUpdate = false) {
      isEditing = forceUpdate ? true : !isEditing;
      const fields = document.querySelectorAll('.editable-field');
      
      fields.forEach(field => {
        const inputs = field.querySelectorAll('.edit-input');
        const displays = field.querySelectorAll('p, h3');
        
        if(isEditing) {
          field.classList.add('editing');
          inputs.forEach(input => input.style.display = 'block');
          displays.forEach(d => d.style.display = 'none');
        } else {
          field.classList.remove('editing');
          inputs.forEach(input => input.style.display = 'none');
          displays.forEach(d => d.style.display = 'block');
        }
      });

      document.getElementById('editUserBtn').style.display = isEditing ? 'none' : 'inline-block';
      document.getElementById('saveUserBtn').style.display = isEditing ? 'inline-block' : 'none';
    }

    async function saveUserChanges() {
      const updates = {};
      const fields = document.querySelectorAll('.editable-field.editing');
      
      fields.forEach(field => {
        const fieldPath = field.dataset.field;
        const inputs = field.querySelectorAll('.edit-input');
        
        if(fieldPath === 'medicamentos') {
          const index = field.dataset.index;
          updates[`medicamentos.${index}`] = {
            nome: inputs[0].value,
            dose: inputs[1].value,
            posologia: inputs[2].value,
            horario: inputs[3].value
          };
        } else if(fieldPath === 'vacinacao') {
          const index = field.dataset.index;
          updates[`vacinacao.${index}`] = {
            nomeVacina: inputs[0].value,
            dataAplicacao: inputs[1].value,
            loteVacina: inputs[2].value,
            observacoes: inputs[3].value
          };
        } else if(fieldPath === 'doencas') {
          const checkboxes = field.querySelectorAll('input[type="checkbox"]');
          updates['doencas'] = {
            hipertensao: checkboxes[0].checked,
            diabetes: checkboxes[1].checked,
            cardiopatias: checkboxes[2].checked,
            chagas: checkboxes[3].checked,
            outras: field.querySelector('input[type="text"]').value
          };
        } else {
          updates[fieldPath] = inputs[0].value;
        }
      });

      try {
        await db.collection('usuarios').doc(currentEditingUser).update(updates);
        showPopup('Alterações salvas com sucesso!');
        toggleEditMode();
      } catch (error) {
        console.error('Erro ao salvar alterações:', error);
        showPopup('Erro ao salvar alterações!', true);
      }
    }

    async function deleteUser() {
      if(confirm('Tem certeza que deseja excluir este usuário permanentemente?')) {
        try {
          await db.collection('usuarios').doc(currentEditingUser).delete();
          showPopup('Usuário excluído com sucesso!');
          closeUserDetail();
          loadMedicalAccess();
        } catch (error) {
          console.error('Erro ao excluir usuário:', error);
          showPopup('Erro ao excluir usuário!', true);
        }
      }
    }

    function closeUserDetail() {
      if(unsubscribeUser) unsubscribeUser();
      document.getElementById('userDetailScreen').style.display = 'none';
      document.getElementById('medicalAccessScreen').style.display = 'block';
    }

    document.getElementById('medLogoutBtn').addEventListener('click', () => {
      document.getElementById('medicalAccessScreen').style.display = 'none';
      document.getElementById('reviewScreen').style.display = 'block';
    });

    // Atualização em tempo real
    function setupRealtimeUpdates(username) {
      return db.collection('usuarios').doc(username).onSnapshot(doc => {
        if(doc.exists) {
          const data = doc.data();
          updateReviewScreen(data);
        }
      });
    }

    // Modificar o carregamento inicial para incluir atualizações em tempo real
    document.addEventListener('DOMContentLoaded', async () => {
      const username = localStorage.getItem('currentUser');
      if(username) {
        const data = await loadUserData(username);
        if(data) {
          updateReviewScreen(data);
          setupRealtimeUpdates(username);
          document.getElementById('homeScreen').style.display = 'none';
          document.getElementById('reviewScreen').style.display = 'block';
        }
      }
    });
  </script>
</body>
</html>
